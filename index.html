<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium POS – Versi Final</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-daterangepicker/3.0.5/daterangepicker.min.css">
    <style>
        :root{
            --primary:#4361ee;--secondary:#3f37c9;--success:#10b981;--danger:#ef4444;
            --warning:#f59e0b;--info:#3b82f6;--dark:#1a1a2e;--light:#f8f9fa;
            --shadow:0 4px 6px -1px rgba(0,0,0,.1);--rounded:.5rem;
            --font:'Poppins',sans-serif;
            --bg-body:#f5f7fa;--bg-card:#fff;--text:#333;
        }

        /* Dark mode override */
        body.dark-mode{
            --bg-body:#1e1e2f;--bg-card:#2a2a3c;--text:#e4e4e7;
        }

        *{margin:0;padding:0;box-sizing:border-box;font-family:var(--font);}
        body{background:var(--bg-body);color:var(--text);line-height:1.6;}
        .container{max-width:100%;margin:0 auto;padding:20px;}
        .header{
            background:linear-gradient(135deg,var(--primary),var(--secondary));
            color:#fff;padding:15px 20px;border-radius:var(--rounded);
            margin-bottom:20px;box-shadow:var(--shadow);
            display:flex;justify-content:space-between;align-items:center;
        }
        .header h1{font-size:1.8rem;font-weight:600;}
        .header-info{text-align:right;}
        .header-info p{margin:2px 0;font-size:.9rem;}
        .main-content{display:flex;flex-wrap:wrap;gap:20px;}
        .left-panel,.right-panel{background:var(--bg-card);border-radius:var(--rounded);
            padding:20px;box-shadow:var(--shadow);}
        .left-panel{flex:1;min-width:300px;}
        .right-panel{flex:2;min-width:400px;}
        .panel-title{font-size:1.2rem;margin-bottom:15px;border-bottom:2px solid var(--primary);
            padding-bottom:5px;font-weight:600;}
        .form-group{margin-bottom:15px;}
        .form-group label{display:block;margin-bottom:5px;font-weight:500;}
        .form-control{width:100%;padding:10px 15px;border:1px solid #ddd;border-radius:.25rem;}
        .btn{display:inline-block;padding:10px 20px;border:none;border-radius:.25rem;
            cursor:pointer;font-size:1rem;transition:.3s;font-weight:500;}
        .btn-primary{background:var(--primary);color:#fff;}
        .btn-success{background:var(--success);color:#fff;}
        .btn-danger{background:var(--danger);color:#fff;}
        .btn-warning{background:var(--warning);color:#fff;}
        .btn-sm{padding:5px 10px;font-size:.85rem;}
        .btn-block{display:block;width:100%;}
        .table-responsive{overflow-x:auto;border-radius:.25rem;box-shadow:var(--shadow);}
        .table{width:100%;border-collapse:collapse;margin-bottom:0;}
        .table th,.table td{padding:12px 15px;text-align:left;border-bottom:1px solid #ddd;}
        .table th{background:#f1f3f5;font-weight:500;position:sticky;top:0;}
        .badge{display:inline-block;padding:3px 8px;border-radius:20px;font-size:.75rem;font-weight:500;}
        .badge-success{background:var(--success);color:#fff;}
        .badge-danger{background:var(--danger);color:#fff;}
        .search-box{position:relative;margin-bottom:20px;}
        .search-box input{padding-left:40px;}
        .search-box i{position:absolute;left:15px;top:50%;transform:translateY(-50%);color:#999;}
        .cart-item{display:flex;justify-content:space-between;align-items:center;
            padding:10px 0;border-bottom:1px solid #eee;}
        .cart-item:last-child{border-bottom:none;}
        .cart-item-info{flex:1;}
        .cart-item-name{font-weight:500;}
        .cart-item-price{color:#666;font-size:.9rem;}
        .cart-item-qty{display:flex;align-items:center;}
        .cart-item-qty input{width:50px;text-align:center;margin:0 5px;}
        .cart-summary{margin-top:20px;padding-top:15px;border-top:2px dashed #ddd;}
        .summary-row{display:flex;justify-content:space-between;margin-bottom:10px;}
        .total-row{font-size:1.1rem;color:var(--primary);border-top:1px solid #ddd;padding-top:10px;}
        .tabs{display:flex;border-bottom:1px solid #ddd;margin-bottom:20px;}
        .tab{padding:10px 20px;cursor:pointer;border-bottom:2px solid transparent;}
        .tab.active{border-bottom:2px solid var(--primary);color:var(--primary);font-weight:500;}
        .tab-content{display:none;animation:fadeIn .3s;}
        .tab-content.active{display:block;}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;
            background:rgba(0,0,0,.5);z-index:1000;justify-content:center;align-items:center;}
        .modal-content{background:var(--bg-card);border-radius:var(--rounded);width:90%;max-width:800px;
            max-height:90vh;overflow-y:auto;padding:20px;box-shadow:var(--shadow);}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;}
        .modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;}
        .toast{position:fixed;top:20px;right:20px;padding:15px 20px;border-radius:.25rem;
            color:#fff;z-index:1100;transform:translateX(200%);transition:transform .3s;}
        .toast.show{transform:translateX(0);}
        .empty-state{text-align:center;padding:30px;color:#666;}
        .empty-state i{font-size:3rem;color:#ddd;margin-bottom:15px;}
        /* Dark mode toggle */
        .dark-mode-toggle{position:fixed;top:20px;right:70px;background:var(--bg-card);border:none;
            border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;
            box-shadow:var(--shadow);cursor:pointer;z-index:100;}
        /* QR Code container */
        .qr-container{text-align:center;margin:20px 0;}
        /* Responsive */
        @media(max-width:768px){
            .main-content{flex-direction:column;}
            .left-panel,.right-panel{min-width:100%;}
            .header{flex-direction:column;text-align:center;}
            .header-info{text-align:center;margin-top:10px;}
        }
    </style>
</head>
<body>
    <!-- Toast -->
    <div id="toast" class="toast"><i class="fas fa-info-circle"></i> <span id="toast-message">Notifikasi</span></div>

    <!-- Dark Mode Toggle -->
    <button id="darkModeToggle" class="dark-mode-toggle" title="Mode Gelap"><i class="fas fa-moon"></i></button>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="login-container">
            <h2 class="login-title">Premium POS – Login</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label>Pilih Toko</label>
                    <select id="storeSelect" class="form-control">
                        <option value="toko1">Toko Utama</option>
                        <option value="toko2">Toko Cabang</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ID Kasir</label>
                    <input type="text" id="cashierId" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>PIN</label>
                    <input type="password" id="cashierPin" class="form-control" maxlength="4" required>
                </div>
                <button type="submit" class="btn btn-primary btn-block">Login</button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" style="display:none;">
        <!-- Header -->
        <div class="header">
            <div>
                <h1 id="storeName">Premium POS</h1>
                <p id="storeAddress">Jl. Contoh No. 123</p>
            </div>
            <div class="header-info">
                <p id="currentDate">Senin, 1 Jan 2023 10:00</p>
                <p>Kasir: <span id="loggedInCashier">-</span> | <a href="#" id="logoutBtn">Logout</a></p>
            </div>
        </div>

        <!-- Content -->
        <div class="main-content">
            <!-- Left Panel -->
            <div class="left-panel">
                <h2 class="panel-title">Produk</h2>
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="productSearch" class="form-control" placeholder="Cari produk...">
                </div>
                <div class="form-group">
                    <label>Kategori</label>
                    <select id="productCategory" class="form-control">
                        <option value="all">Semua Kategori</option>
                    </select>
                </div>
                <div id="productList" class="table-responsive">
                    <table class="table">
                        <thead><tr><th>Nama</th><th>Harga</th><th>Stok</th><th>Aksi</th></tr></thead>
                        <tbody id="productListBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="right-panel">
                <h2 class="panel-title">Transaksi</h2>
                <div class="tabs">
                    <div class="tab active" data-tab="cart">Keranjang</div>
                    <div class="tab" data-tab="customer">Pelanggan</div>
                    <div class="tab" data-tab="payment">Pembayaran</div>
                </div>

                <!-- Cart -->
                <div class="tab-content active" id="cartTab">
                    <div id="cartItems"></div>
                    <div class="cart-summary">
                        <div class="summary-row"><span>Subtotal</span><span id="cartSubtotal">Rp 0</span></div>
                        <div class="summary-row"><span>Diskon</span><span id="cartDiscount">Rp 0</span></div>
                        <div class="summary-row"><span>Pajak</span><span id="cartTax">Rp 0</span></div>
                        <div class="summary-row total-row"><span>Total</span><span id="cartTotal">Rp 0</span></div>
                    </div>
                    <button id="nextToCustomer" class="btn btn-primary btn-block mt-2">Lanjut ke Pelanggan</button>
                    <button id="holdBill" class="btn btn-warning btn-block">Hold Bill</button>
                </div>

                <!-- Customer -->
                <div class="tab-content" id="customerTab">
                    <div class="form-group">
                        <label>Tipe Pelanggan</label>
                        <select id="customerType" class="form-control">
                            <option value="walkin">Biasa</option>
                            <option value="member">Member</option>
                        </select>
                    </div>
                    <div id="memberFields" style="display:none;">
                        <div class="form-group">
                            <label>ID Member</label>
                            <div class="input-group">
                                <input type="text" id="memberId" class="form-control">
                                <button id="searchMember" class="btn btn-info">Cari</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Diskon Member (%)</label>
                            <input type="number" id="memberDiscount" class="form-control" value="10">
                        </div>
                    </div>
                    <div class="buttons">
                        <button id="backToCart" class="btn btn-warning">Kembali</button>
                        <button id="nextToPayment" class="btn btn-primary float-right">Lanjut Bayar</button>
                    </div>
                </div>

                <!-- Payment -->
                <div class="tab-content" id="paymentTab">
                    <div class="cart-summary">
                        <div class="summary-row"><span>Total</span><span id="paymentTotal">Rp 0</span></div>
                    </div>
                    <div class="form-group">
                        <label>Jumlah Bayar</label>
                        <input type="number" id="paymentAmount" class="form-control">
                    </div>
                    <div class="payment-methods">
                        <label>Metode Pembayaran</label>
                        <div class="payment-method">
                            <input type="radio" name="paymentMethod" value="cash" checked> Tunai
                        </div>
                        <div class="payment-method">
                            <input type="radio" name="paymentMethod" value="transfer"> Transfer
                        </div>
                        <div class="payment-method">
                            <input type="radio" name="paymentMethod" value="ewallet"> E-Wallet
                        </div>
                    </div>
                    <div class="buttons">
                        <button id="backToCustomer" class="btn btn-warning">Kembali</button>
                        <button id="completePayment" class="btn btn-success float-right">Selesai & Cetak</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Admin -->
    <div id="adminModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Admin Dashboard</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab admin-tab active" data-tab="products">Produk</div>
                    <div class="tab admin-tab" data-tab="categories">Kategori</div>
                    <div class="tab admin-tab" data-tab="customers">Pelanggan</div>
                    <div class="tab admin-tab" data-tab="cashiers">Kasir</div>
                    <div class="tab admin-tab" data-tab="transactions">Transaksi</div>
                    <div class="tab admin-tab" data-tab="reports">Laporan</div>
                    <div class="tab admin-tab" data-tab="settings">Pengaturan</div>
                </div>

                <!-- Products Tab -->
                <div class="tab-content admin-tab-content active" id="productsTab">
                    <button id="addProduct" class="btn btn-success mb-2">+ Tambah Produk</button>
                    <input type="file" id="importProductFile" accept=".xlsx" style="display:none">
                    <button id="importProductBtn" class="btn btn-info mb-2 ml-2">Import Excel</button>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr><th>Barcode</th><th>Nama</th><th>Merk</th><th>Kat.</th><th>Harga</th><th>Stok</th><th>Aksi</th></tr>
                            </thead>
                            <tbody id="adminProductsTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Other admin tabs -->
                <div class="tab-content admin-tab-content" id="categoriesTab">
                    <button id="addCategory" class="btn btn-success mb-2">+ Tambah Kategori</button>
                    <div class="table-responsive">
                        <table class="table">
                            <thead><tr><th>Nama</th><th>Produk</th><th>Aksi</th></tr></thead>
                            <tbody id="adminCategoriesTable"></tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-content admin-tab-content" id="customersTab">
                    <button id="addCustomer" class="btn btn-success mb-2">+ Tambah Pelanggan</button>
                    <div class="table-responsive">
                        <table class="table">
                            <thead><tr><th>Nama</th><th>Telepon</th><th>Poin</th><th>Aksi</th></tr></thead>
                            <tbody id="adminCustomersTable"></tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-content admin-tab-content" id="cashiersTab">
                    <button id="addCashier" class="btn btn-success mb-2">+ Tambah Kasir</button>
                    <div class="table-responsive">
                        <table class="table">
                            <thead><tr><th>Nama</th><th>Role</th><th>Status</th><th>Aksi</th></tr></thead>
                            <tbody id="adminCashiersTable"></tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-content admin-tab-content" id="transactionsTab">
                    <input id="transactionDateRange" class="form-control mb-2" placeholder="Rentang Tanggal">
                    <div class="table-responsive">
                        <table class="table">
                            <thead><tr><th>ID</th><th>Tanggal</th><th>Total</th><th>Kasir</th><th>Aksi</th></tr></thead>
                            <tbody id="adminTransactionsTable"></tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-content admin-tab-content" id="reportsTab">
                    <input id="reportDateRange" class="form-control mb-2" placeholder="Rentang Laporan">
                    <div class="report-summary">
                        <div class="report-card"><div class="report-card-title">Total Transaksi</div><div class="report-card-value" id="reportTotalTransactions">0</div></div>
                        <div class="report-card"><div class="report-card-title">Pendapatan</div><div class="report-card-value" id="reportTotalRevenue">Rp 0</div></div>
                        <div class="report-card"><div class="report-card-title">Produk Terlaris</div><div class="report-card-value" id="reportBestSeller">-</div></div>
                    </div>
                    <canvas id="salesChart" height="300"></canvas>
                    <div class="mt-2">
                        <button id="exportReportPDF" class="btn btn-info">PDF</button>
                        <button id="exportReportExcel" class="btn btn-success">Excel</button>
                    </div>
                </div>

                <div class="tab-content admin-tab-content" id="settingsTab">
                    <div class="form-group">
                        <label>Nama Toko</label>
                        <input type="text" id="storeNameSetting" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Alamat Toko</label>
                        <textarea id="storeAddressSetting" class="form-control"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Telepon Toko</label>
                        <input type="text" id="storePhoneSetting" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Logo Toko (URL)</label>
                        <input type="text" id="storeLogoSetting" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Pajak (%)</label>
                        <input type="number" id="storeTaxRate" class="form-control" min="0" max="100">
                    </div>
                    <button id="saveSettings" class="btn btn-success">Simpan Pengaturan</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary close-admin-modal">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Admin Access FAB -->
    <div id="adminAccess" class="fab" title="Admin Access"><i class="fas fa-cogs"></i></div>

    <!-- Script Bagian 2-4 akan dilanjutkan di bagian selanjutnya -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-daterangepicker/3.0.5/daterangepicker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        /* ============ Bagian 2 : Variabel & Inisialisasi Data ============ */
        const STORAGE = {
            STORE     : 'pos_store',
            PRODUCTS  : 'pos_products',
            CATEGORIES: 'pos_categories',
            CUSTOMERS : 'pos_customers',
            CASHIERS  : 'pos_cashiers',
            TRANSACTIONS: 'pos_transactions',
            SETTINGS  : 'pos_settings',
            CART      : 'pos_cart',
            HOLDBILLS : 'pos_holdbills',
            CURRENT_CASHIER: 'pos_current_cashier'
        };

        let store = JSON.parse(localStorage.getItem(STORAGE.STORE)) || { id:'toko1', name:'Toko Utama' };
        let products   = JSON.parse(localStorage.getItem(STORAGE.PRODUCTS)) || [];
        let categories = JSON.parse(localStorage.getItem(STORAGE.CATEGORIES)) || [];
        let customers  = JSON.parse(localStorage.getItem(STORAGE.CUSTOMERS)) || [];
        let cashiers   = JSON.parse(localStorage.getItem(STORAGE.CASHIERS)) || [
            {id:'K001',name:'Admin',pin:'1234',role:'admin',status:'active'},
            {id:'K002',name:'Kasir 1',pin:'1111',role:'cashier',status:'active'}
        ];
        let transactions = JSON.parse(localStorage.getItem(STORAGE.TRANSACTIONS)) || [];
        let settings = JSON.parse(localStorage.getItem(STORAGE.SETTINGS)) || {
            storeName:'Premium POS',
            storeAddress:'Jl. Contoh No. 123',
            storePhone:'081234567890',
            storeLogo:'',
            taxRate:10
        };
        let currentCart = JSON.parse(localStorage.getItem(STORAGE.CART)) || {items:[],discount:0,tax:0,subtotal:0,total:0,customer:null};
        let currentCashier = JSON.parse(localStorage.getItem(STORAGE.CURRENT_CASHIER)) || null;
        let holdBills = JSON.parse(localStorage.getItem(STORAGE.HOLDBILLS)) || [];
        let salesChart = null;

        /* ============ Fungsi Utilitas ============ */
        const formatCurrency = (num) => 'Rp ' + (num||0).toLocaleString('id-ID');
        const showToast = (msg,type='info') => {
            const t = $('#toast'); t.removeClass().addClass('toast ' + type).addClass('show').find('#toast-message').text(msg);
            setTimeout(()=>t.removeClass('show'),3000);
        };
        const saveAll = () => {
            localStorage.setItem(STORAGE.PRODUCTS,JSON.stringify(products));
            localStorage.setItem(STORAGE.CATEGORIES,JSON.stringify(categories));
            localStorage.setItem(STORAGE.CUSTOMERS,JSON.stringify(customers));
            localStorage.setItem(STORAGE.CASHIERS,JSON.stringify(cashiers));
            localStorage.setItem(STORAGE.TRANSACTIONS,JSON.stringify(transactions));
            localStorage.setItem(STORAGE.SETTINGS,JSON.stringify(settings));
            localStorage.setItem(STORAGE.CART,JSON.stringify(currentCart));
            localStorage.setItem(STORAGE.HOLDBILLS,JSON.stringify(holdBills));
            localStorage.setItem(STORAGE.CURRENT_CASHIER,JSON.stringify(currentCashier));
        };

        /* ============ Bagian 3 : Login & Dashboard ============ */
        $(document).ready(() => {
            /* Dark Mode Toggle */
            $('#darkModeToggle').click(()=>{
                $('body').toggleClass('dark-mode');
                $('#darkModeToggle i').toggleClass('fa-moon fa-sun');
            });

            /* Login */
            $('#loginForm').submit(e=>{
                e.preventDefault();
                const cid = $('#cashierId').val().trim();
                const pin = $('#cashierPin').val().trim();
                const cashier = cashiers.find(c=>c.id===cid && c.pin===pin && c.status==='active');
                if(cashier){
                    currentCashier = cashier;
                    saveAll();
                    $('#loginModal').hide();
                    $('#mainApp').fadeIn();
                    $('#loggedInCashier').text(cashier.name);
                    loadProducts();
                    updateCart();
                    loadSettingsUI();
                }else{
                    showToast('ID/PIN salah atau tidak aktif','error');
                }
            });

            /* Logout */
            $('#logoutBtn').click(e=>{
                e.preventDefault();
                currentCashier=null;
                localStorage.removeItem(STORAGE.CURRENT_CASHIER);
                $('#mainApp').fadeOut();
                $('#loginModal').fadeIn();
            });

            /* Tabs */
            $('.tab').click(function(){
                const tab = $(this).data('tab');
                $(this).siblings().removeClass('active');
                $(this).addClass('active');
                $('.tab-content').hide();
                $(`#${tab}Tab`).fadeIn();
            });

            /* Admin Modal */
            $('#adminAccess').click(()=>$('#adminModal').fadeIn());
            $('.close-admin-modal').click(()=>$('#adminModal').fadeOut());

            /* Admin Tabs */
            $(document).on('click','.admin-tab',function(){
                const tab = $(this).data('tab');
                $('.admin-tab').removeClass('active');
                $(this).addClass('active');
                $('.admin-tab-content').hide();
                $(`#${tab}Tab`).fadeIn();
                if(tab==='reports') loadSalesReport();
            });

            /* Load Settings UI */
            const loadSettingsUI = () => {
                $('#storeNameSetting').val(settings.storeName);
                $('#storeAddressSetting').val(settings.storeAddress);
                $('#storePhoneSetting').val(settings.storePhone);
                $('#storeLogoSetting').val(settings.storeLogo);
                $('#storeTaxRate').val(settings.taxRate);
            };

            /* Save Settings */
            $('#saveSettings').click(()=>{
                settings.storeName = $('#storeNameSetting').val();
                settings.storeAddress = $('#storeAddressSetting').val();
                settings.storePhone = $('#storePhoneSetting').val();
                settings.storeLogo = $('#storeLogoSetting').val();
                settings.taxRate = parseInt($('#storeTaxRate').val())||0;
                saveAll();
                loadSettingsUI();
                showToast('Pengaturan disimpan','success');
            });

            /* Product List */
            const loadProducts = (search='',cat='all') => {
                let list = products;
                if(search) list = list.filter(p=>p.name.toLowerCase().includes(search.toLowerCase()) || p.barcode.includes(search));
                if(cat!=='all') list = list.filter(p=>p.categoryId===cat);
                $('#productListBody').empty();
                if(!list.length){
                    $('#productListBody').html(`<tr><td colspan="4"><div class="empty-state"><i class="fas fa-box-open"></i><p>Tidak ada produk</p></div></td></tr>`);
                }else{
                    list.forEach(p=>{
                        const stockClass = p.stock>5?'text-success':p.stock>0?'text-warning':'text-danger';
                        $('#productListBody').append(`
                            <tr>
                                <td>${p.name}<br><small>${p.brand} • ${p.unit}</small></td>
                                <td>${formatCurrency(p.price)}</td>
                                <td class="${stockClass}">${p.stock}</td>
                                <td>
                                    <button class="btn btn-success btn-sm add-to-cart" data-id="${p.id}" ${p.stock<=0?'disabled':''}>
                                        <i class="fas fa-cart-plus"></i>
                                    </button>
                                </td>
                            </tr>
                        `);
                    });
                }
            };

            /* Category Dropdown */
            const loadCategoryDropdown = () => {
                $('#productCategory').empty().append('<option value="all">Semua Kategori</option>');
                categories.forEach(c=>{
                    $('#productCategory').append(`<option value="${c.id}">${c.name}</option>`);
                });
            };

            /* Cart */
            const updateCart = () => {
                currentCart.subtotal = currentCart.items.reduce((a,i)=>a+(i.product.price*i.quantity),0);
                currentCart.tax = (currentCart.subtotal * settings.taxRate) / 100;
                currentCart.total = currentCart.subtotal + currentCart.tax - currentCart.discount;
                $('#cartItems').empty();
                if(!currentCart.items.length){
                    $('#cartItems').html(`<div class="empty-state"><i class="fas fa-shopping-cart"></i><p>Keranjang kosong</p></div>`);
                }else{
                    currentCart.items.forEach(item=>{
                        $('#cartItems').append(`
                            <div class="cart-item">
                                <div>
                                    <div>${item.product.name}</div>
                                    <div>${formatCurrency(item.product.price)} x ${item.quantity}</div>
                                </div>
                                <div>
                                    <input type="number" class="cart-item-quantity" data-id="${item.product.id}" value="${item.quantity}" min="1" max="${item.product.stock}" style="width:60px">
                                    <button class="btn btn-danger btn-sm remove-from-cart" data-id="${item.product.id}"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        `);
                    });
                }
                $('#cartSubtotal').text(formatCurrency(currentCart.subtotal));
                $('#cartDiscount').text(formatCurrency(currentCart.discount));
                $('#cartTax').text(formatCurrency(currentCart.tax));
                $('#cartTotal').text(formatCurrency(currentCart.total));
                $('#paymentTotal').text(formatCurrency(currentCart.total));
                saveAll();
            };

            /* Add to Cart */
            $(document).on('click','.add-to-cart',function(){
                const id = $(this).data('id');
                const prod = products.find(p=>p.id===id);
                if(!prod || prod.stock<=0) return showToast('Stok habis','error');
                const item = currentCart.items.find(i=>i.product.id===id);
                if(item){
                    if(item.quantity<prod.stock) item.quantity++; else showToast('Stok tidak cukup','error');
                }else{
                    currentCart.items.push({product:prod,quantity:1});
                }
                updateCart();
            });

            /* Remove from Cart */
            $(document).on('click','.remove-from-cart',function(){
                const id = $(this).data('id');
                currentCart.items = currentCart.items.filter(i=>i.product.id!==id);
                updateCart();
            });

            /* Quantity Change */
            $(document).on('input','.cart-item-quantity',function(){
                const id = $(this).data('id');
                const qty = parseInt($(this).val())||1;
                const prod = products.find(p=>p.id===id);
                const item = currentCart.items.find(i=>i.product.id===id);
                if(!item) return;
                if(qty>prod.stock){$(this).val(prod.stock);item.quantity=prod.stock;showToast('Stok tidak cukup','error');}else{item.quantity=qty;}
                updateCart();
            });

            /* Customer */
            $('#customerType').change(()=>{
                $('#memberFields').toggle($('#customerType').val()==='member');
            });
            $('#searchMember').click(()=>{
                const mid = $('#memberId').val().trim();
                const cust = customers.find(c=>c.id===mid && c.type==='member');
                if(cust){
                    $('#customerName').val(cust.name);
                    $('#customerPhone').val(cust.phone);
                    const disc = parseInt($('#memberDiscount').val())||0;
                    currentCart.discount = (currentCart.subtotal*disc)/100;
                    updateCart();
                    showToast(`Member ${cust.name} ditemukan`,'success');
                }else{
                    showToast('Member tidak ditemukan','error');
                }
            });

            /* Hold Bill */
            $('#holdBill').click(()=>{
                if(!currentCart.items.length){showToast('Keranjang kosong','warning');return;}
                holdBills.push({...currentCart,id:'Hold'+Date.now(),date:new Date()});
                saveAll();
                resetCart();
                showToast('Bill ditahan','info');
            });

            /* Payment */
            $('#completePayment').click(()=>{
                const pay = parseFloat($('#paymentAmount').val())||0;
                if(pay<currentCart.total){showToast('Uang kurang','error');return;}
                const tx = {
                    id:'TX'+Date.now(),
                    date:new Date(),
                    items:currentCart.items,
                    customer:currentCart.customer,
                    subtotal:currentCart.subtotal,
                    discount:currentCart.discount,
                    tax:currentCart.tax,
                    total:currentCart.total,
                    paymentMethod:$('input[name="paymentMethod"]:checked').val(),
                    paymentAmount:pay,
                    change:pay-currentCart.total,
                    cashier:currentCashier
                };
                transactions.unshift(tx);
                tx.items.forEach(i=>{
                    const p = products.find(prod=>prod.id===i.product.id);
                    if(p) p.stock-=i.quantity;
                });
                saveAll();
                generateReceipt(tx);
                window.print();
                resetCart();
                showToast('Transaksi selesai','success');
                $('.tab').removeClass('active').first().addClass('active');
                $('.tab-content').hide().first().fadeIn();
            });

            const resetCart = () => {
                currentCart = {items:[],discount:0,tax:0,subtotal:0,total:0,customer:null};
                saveAll();
                updateCart();
                $('#customerType').val('walkin');
                $('#memberId').val('');
                $('#paymentAmount').val('');
            };

            /* Admin Data Load */
            const loadAdminProducts = () => {
                $('#adminProductsTable').empty();
                products.forEach(p=>{
                    const cat = categories.find(c=>c.id===p.categoryId);
                    $('#adminProductsTable').append(`
                        <tr>
                            <td>${p.barcode}</td><td>${p.name}</td><td>${p.brand||'-'}</td>
                            <td>${cat?cat.name:'-'}</td><td>${formatCurrency(p.price)}</td>
                            <td>${p.stock}</td>
                            <td>
                                <button class="btn btn-info btn-sm edit-product" data-id="${p.id}"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-danger btn-sm delete-product" data-id="${p.id}"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `);
                });
            };
            const loadAdminCategories = () => {
                $('#adminCategoriesTable').empty();
                categories.forEach(c=>{
                    const count = products.filter(p=>p.categoryId===c.id).length;
                    $('#adminCategoriesTable').append(`
                        <tr>
                            <td>${c.name}</td><td>${count}</td>
                            <td>
                                <button class="btn btn-info btn-sm edit-category" data-id="${c.id}"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-danger btn-sm delete-category" data-id="${c.id}"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `);
                });
            };
            const loadAdminCustomers = () => {
                $('#adminCustomersTable').empty();
                customers.forEach(c=>{
                    $('#adminCustomersTable').append(`
                        <tr>
                            <td>${c.name}</td><td>${c.phone}</td><td>${c.points||0}</td>
                            <td>
                                <button class="btn btn-info btn-sm edit-customer" data-id="${c.id}"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-danger btn-sm delete-customer" data-id="${c.id}"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `);
                });
            };
            const loadAdminCashiers = () => {
                $('#adminCashiersTable').empty();
                cashiers.forEach(c=>{
                    $('#adminCashiersTable').append(`
                        <tr>
                            <td>${c.name}</td><td>${c.role}</td><td>${c.status}</td>
                            <td>
                                <button class="btn btn-info btn-sm edit-cashier" data-id="${c.id}"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-danger btn-sm delete-cashier" data-id="${c.id}"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `);
                });
            };
            const loadAdminTransactions = (start,end) => {
                let list = transactions;
                if(start && end){
                    list = list.filter(t=>moment(t.date).isBetween(start,end));
                }
                $('#adminTransactionsTable').empty();
                list.forEach(t=>{
                    $('#adminTransactionsTable').append(`
                        <tr>
                            <td>${t.id}</td><td>${moment(t.date).format('DD/MM/YY HH:mm')}</td>
                            <td>${formatCurrency(t.total)}</td><td>${t.cashier.name}</td>
                            <td>
                                <button class="btn btn-info btn-sm view-transaction" data-id="${t.id}"><i class="fas fa-eye"></i></button>
                            </td>
                        </tr>
                    `);
                });
            };

            /* Sales Report Chart */
            const loadSalesReport = (start,end) => {
                let list = transactions;
                if(start && end){
                    list = list.filter(t=>moment(t.date).isBetween(start,end));
                }
                const daily = {};
                list.forEach(t=>{
                    const day = moment(t.date).format('DD/MM');
                    daily[day]=(daily[day]||0)+t.total;
                });
                const labels = Object.keys(daily).sort();
                const data   = labels.map(l=>daily[l]);

                const ctx = document.getElementById('salesChart').getContext('2d');
                if(salesChart) salesChart.destroy();
                salesChart = new Chart(ctx,{
                    type:'bar',
                    data:{labels,datasets:[{label:'Penjualan',data,backgroundColor:['#4361ee']}]},
                    options:{responsive:true,scales:{y:{beginAtZero:true}}}
                });

                $('#reportTotalTransactions').text(list.length);
                $('#reportTotalRevenue').text(formatCurrency(list.reduce((a,t)=>a+t.total,0)));
            };

            /* Date Range */
            $('#transactionDateRange, #reportDateRange').daterangepicker({
                locale:{format:'DD/MM/YYYY'}
            },(start,end)=>{
                loadAdminTransactions(start,end);
                loadSalesReport(start,end);
            });

            /* Modal Close */
            $('.modal-close').click(function(){$(this).closest('.modal').hide();});

            /* Export PDF / Excel */
            $('#exportReportPDF').click(()=>window.print());
            $('#exportReportExcel').click(()=>{
                const ws = XLSX.utils.json_to_sheet(transactions.map(t=>({
                    ID:t.id,
                    Tanggal:moment(t.date).format('DD/MM/YYYY HH:mm'),
                    Total:t.total,
                    Kasir:t.cashier.name
                })));
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Transaksi');
                XLSX.writeFile(wb,'Laporan_Transaksi.xlsx');
            });

            /* Import Excel */
            $('#importProductBtn').click(()=>$('#importProductFile').click());
            $('#importProductFile').change(e=>{
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function (ev){
                    const wb = XLSX.read(ev.target.result,{type:'binary'});
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const data = XLSX.utils.sheet_to_json(ws,{header:1});
                    data.slice(1).forEach(row=>{
                        const [barcode,name,brand,unit,category,price,stock]=row;
                        if(!products.find(p=>p.barcode==barcode)){
                            products.push({
                                id:'P'+Date.now()+Math.random().toString(36).substr(2,5),
                                barcode,name,brand,unit,
                                categoryId:category,
                                price:Number(price),
                                stock:Number(stock)
                            });
                        }
                    });
                    saveAll();
                    loadProducts();
                    loadAdminProducts();
                    showToast('Produk diimport','success');
                };
                reader.readAsBinaryString(file);
            });

            /* Generate Receipt */
            const generateReceipt = (tx)=>{
                const div = document.createElement('div');
                div.className='receipt no-print';
                div.innerHTML=`
                    <div style="text-align:center;margin-bottom:10px;">
                        ${settings.storeLogo?`<img src="${settings.storeLogo}" style="max-width:100px;">`:''}
                        <h3>${settings.storeName}</h3>
                        <p>${settings.storeAddress}<br>${settings.storePhone}</p>
                        <hr>
                        <p>${moment(tx.date).format('DD/MM/YYYY HH:mm')} - Kasir: ${tx.cashier.name}</p>
                    </div>
                    <table style="width:100%;border-collapse:collapse;">
                        ${tx.items.map(i=>`
                            <tr>
                                <td>${i.product.name} (${i.quantity}x)</td>
                                <td style="text-align:right">${formatCurrency(i.product.price*i.quantity)}</td>
                            </tr>
                        `).join('')}
                    </table>
                    <hr>
                    <div style="text-align:right;">
                        <div>Subtotal: ${formatCurrency(tx.subtotal)}</div>
                        <div>Diskon: ${formatCurrency(tx.discount)}</div>
                        <div>Pajak: ${formatCurrency(tx.tax)}</div>
                        <div><strong>Total: ${formatCurrency(tx.total)}</strong></div>
                        <div>Tunai: ${formatCurrency(tx.paymentAmount)}</div>
                        <div>Kembali: ${formatCurrency(tx.change)}</div>
                    </div>
                    <div style="text-align:center;margin-top:10px;font-size:.8em;">Terima kasih!</div>
                `;
                document.body.appendChild(div);
                setTimeout(()=>div.remove(),10000);
            };

            /* Initialize */
            loadProducts();
            loadCategoryDropdown();
            updateCart();
            loadSettingsUI();
            updateCurrentDate();
            setInterval(updateCurrentDate,60000);

            /* Auto Backup Cloud (mock) */
            setInterval(()=>{
                // Simulate cloud backup
                console.log('Auto backup to cloud...');
            },300000);
        });
    </script>

    <script>
/* =========================================================
   BAGIAN 2 – FUNGSI INTI, LOGIN, DASHBOARD, MANAJEMEN DATA
   ========================================================= */

/* ---------------------------------------------------------
   1. PENGECEKAN LOGIN AWAL
--------------------------------------------------------- */
$(document).ready(function () {
    /* Dark-mode toggle */
    const toggleBtn = $('#darkModeToggle');
    toggleBtn.on('click', function () {
        $('body').toggleClass('dark-mode');
        toggleBtn.find('i').toggleClass('fa-moon fa-sun');
    });

    /* Jika belum login → tampilkan modal login */
    if (!currentCashier) {
        $('#loginModal').fadeIn();
    } else {
        $('#loggedInCashier').text(currentCashier.name);
        $('#mainApp').fadeIn();
        loadProducts();
        loadCategoryDropdown();
        updateCart();
        loadSettingsUI();
        updateCurrentDate();
    }

    /* Auto update jam */
    setInterval(updateCurrentDate, 60000);
});

/* ---------------------------------------------------------
   2. FUNGSI UMUM
--------------------------------------------------------- */
const formatCurrency = (amount) => {
    return 'Rp ' + (amount || 0).toLocaleString('id-ID');
};

const showToast = (message, type = 'info') => {
    const toast = $('#toast');
    toast.removeClass()
         .addClass(`toast ${type}`)
         .addClass('show')
         .find('#toast-message')
         .text(message);
    setTimeout(() => toast.removeClass('show'), 3000);
};

const saveAll = () => {
    localStorage.setItem(STORAGE.PRODUCTS, JSON.stringify(products));
    localStorage.setItem(STORAGE.CATEGORIES, JSON.stringify(categories));
    localStorage.setItem(STORAGE.CUSTOMERS, JSON.stringify(customers));
    localStorage.setItem(STORAGE.CASHIERS, JSON.stringify(cashiers));
    localStorage.setItem(STORAGE.TRANSACTIONS, JSON.stringify(transactions));
    localStorage.setItem(STORAGE.SETTINGS, JSON.stringify(settings));
    localStorage.setItem(STORAGE.CART, JSON.stringify(currentCart));
    localStorage.setItem(STORAGE.HOLDBILLS, JSON.stringify(holdBills));
    localStorage.setItem(STORAGE.CURRENT_CASHIER, JSON.stringify(currentCashier));
};

/* ---------------------------------------------------------
   3. LOGIN & LOGOUT
--------------------------------------------------------- */
$('#loginForm').on('submit', function (e) {
    e.preventDefault();
    const storeId = $('#storeSelect').val();
    const cashierId = $('#cashierId').val().trim();
    const pin = $('#cashierPin').val().trim();

    const cashier = cashiers.find(c =>
        c.id === cashierId &&
        c.pin === pin &&
        c.status === 'active'
    );

    if (cashier) {
        currentCashier = cashier;
        saveAll();
        $('#loginModal').hide();
        $('#mainApp').fadeIn();
        $('#loggedInCashier').text(cashier.name);
        loadProducts();
        loadCategoryDropdown();
        updateCart();
        loadSettingsUI();
        updateCurrentDate();
        showToast('Login berhasil', 'success');
    } else {
        showToast('ID/PIN salah atau tidak aktif', 'error');
    }
});

$('#logoutBtn').on('click', function (e) {
    e.preventDefault();
    currentCashier = null;
    localStorage.removeItem(STORAGE.CURRENT_CASHIER);
    $('#mainApp').fadeOut();
    $('#loginModal').fadeIn();
});

/* ---------------------------------------------------------
   4. TAB NAVIGASI
--------------------------------------------------------- */
$(document).on('click', '.tab:not(.admin-tab)', function () {
    const tabId = $(this).data('tab');
    $(this).siblings().removeClass('active');
    $(this).addClass('active');
    $('.tab-content').removeClass('active');
    $(`#${tabId}Tab`).addClass('active');
});

$(document).on('click', '.admin-tab', function () {
    const tabId = $(this).data('tab');
    $('.admin-tab').removeClass('active');
    $(this).addClass('active');
    $('.admin-tab-content').removeClass('active');
    $(`#${tabId}Tab`).addClass('active');
    if (tabId === 'reports') loadSalesReport();
});

/* ---------------------------------------------------------
   5. CUSTOMER HANDLING
--------------------------------------------------------- */
$('#customerType').on('change', function () {
    $('#memberFields').toggle($(this).val() === 'member');
});

$('#searchMember').on('click', function () {
    const memberId = $('#memberId').val().trim();
    const customer = customers.find(c => c.id === memberId && c.type === 'member');
    if (customer) {
        $('#customerName').val(customer.name);
        $('#customerPhone').val(customer.phone);
        const disc = parseInt($('#memberDiscount').val()) || 0;
        currentCart.discount = (currentCart.subtotal * disc) / 100;
        currentCart.customer = customer;
        updateCart();
        showToast(`Member ${customer.name} ditemukan`, 'success');
    } else {
        showToast('Member tidak ditemukan', 'error');
    }
});

/* ---------------------------------------------------------
   6. KERANJANG & HOLD BILL
--------------------------------------------------------- */
const updateCart = () => {
    currentCart.subtotal = currentCart.items.reduce((sum, item) => sum + (item.product.price * item.quantity), 0);
    currentCart.tax = (currentCart.subtotal * settings.taxRate) / 100;
    currentCart.total = currentCart.subtotal + currentCart.tax - currentCart.discount;

    $('#cartItems').empty();
    if (!currentCart.items.length) {
        $('#cartItems').html(`<div class="empty-state"><i class="fas fa-shopping-cart"></i><p>Keranjang kosong</p></div>`);
    } else {
        currentCart.items.forEach(item => {
            $('#cartItems').append(`
                <div class="cart-item">
                    <div>
                        <div>${item.product.name}</div>
                        <div class="product-brand-unit">${item.product.brand} • ${item.product.unit}</div>
                        <div>${formatCurrency(item.product.price)} x ${item.quantity}</div>
                    </div>
                    <div style="display:flex;gap:5px">
                        <input type="number" class="cart-item-quantity" data-id="${item.product.id}" value="${item.quantity}" min="1" max="${item.product.stock}" style="width:60px">
                        <button class="btn btn-danger btn-sm remove-from-cart" data-id="${item.product.id}"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `);
        });
    }

    $('#cartSubtotal').text(formatCurrency(currentCart.subtotal));
    $('#cartDiscount').text(formatCurrency(currentCart.discount));
    $('#cartTax').text(formatCurrency(currentCart.tax));
    $('#cartTotal').text(formatCurrency(currentCart.total));
    $('#paymentTotal').text(formatCurrency(currentCart.total));

    saveAll();
};

$(document).on('input', '.cart-item-quantity', function () {
    const id = $(this).data('id');
    const qty = parseInt($(this).val()) || 1;
    const item = currentCart.items.find(i => i.product.id === id);
    const prod = products.find(p => p.id === id);
    if (!item) return;
    if (qty > prod.stock) {
        $(this).val(prod.stock);
        item.quantity = prod.stock;
        showToast('Stok tidak cukup', 'error');
    } else {
        item.quantity = qty;
    }
    updateCart();
});

$(document).on('click', '.remove-from-cart', function () {
    const id = $(this).data('id');
    currentCart.items = currentCart.items.filter(i => i.product.id !== id);
    updateCart();
});

$('#holdBill').on('click', function () {
    if (!currentCart.items.length) return showToast('Keranjang kosong', 'warning');
    holdBills.push({ ...currentCart, id: 'Hold' + Date.now(), date: new Date() });
    saveAll();
    resetCart();
    showToast('Bill ditahan', 'info');
});

/* ---------------------------------------------------------
   7. PRODUK & KATEGORI
--------------------------------------------------------- */
const loadProducts = (search = '', category = 'all') => {
    let list = [...products];
    if (search) {
        list = list.filter(p =>
            p.name.toLowerCase().includes(search.toLowerCase()) ||
            p.barcode.includes(search)
        );
    }
    if (category !== 'all') list = list.filter(p => p.categoryId === category);

    $('#productListBody').empty();
    if (!list.length) {
        $('#productListBody').html(`<tr><td colspan="4"><div class="empty-state"><i class="fas fa-box-open"></i><p>Tidak ada produk</p></div></td></tr>`);
        return;
    }
    list.forEach(p => {
        const stockClass = p.stock > 5 ? 'text-success' : p.stock > 0 ? 'text-warning' : 'text-danger';
        $('#productListBody').append(`
            <tr>
                <td>
                    ${p.name}
                    <div class="product-brand-unit">${p.brand || ''} • ${p.unit || 'Pcs'}</div>
                </td>
                <td>${formatCurrency(p.price)}</td>
                <td class="${stockClass}">${p.stock}</td>
                <td>
                    <button class="btn btn-success btn-sm add-to-cart" data-id="${p.id}" ${p.stock <= 0 ? 'disabled' : ''}>
                        <i class="fas fa-cart-plus"></i>
                    </button>
                </td>
            </tr>
        `);
    });
};

const loadCategoryDropdown = () => {
    $('#productCategory').empty().append('<option value="all">Semua Kategori</option>');
    categories.forEach(c => $('#productCategory').append(`<option value="${c.id}">${c.name}</option>`));
};

/* ---------------------------------------------------------
   8. SETTINGS UI
--------------------------------------------------------- */
const loadSettingsUI = () => {
    $('#storeNameSetting').val(settings.storeName);
    $('#storeAddressSetting').val(settings.storeAddress);
    $('#storePhoneSetting').val(settings.storePhone);
    $('#storeLogoSetting').val(settings.storeLogo);
    $('#storeTaxRate').val(settings.taxRate);
    $('#storeName').text(settings.storeName);
    $('#storeAddress').text(settings.storeAddress);
};

/* ---------------------------------------------------------
   9. NAVIGASI TOMBOL
--------------------------------------------------------- */
$('#nextToCustomer').on('click', function () {
    if (!currentCart.items.length) {
        showToast('Keranjang kosong', 'warning');
        return;
    }
    $('.tab[data-tab="customer"]').trigger('click');
});

$('#backToCart').on('click', () => $('.tab[data-tab="cart"]').trigger('click'));
$('#nextToPayment').on('click', () => $('.tab[data-tab="payment"]').trigger('click'));
$('#backToCustomer').on('click', () => $('.tab[data-tab="customer"]').trigger('click'));

/* ---------------------------------------------------------
   10. UPDATE JAM HARIAN
--------------------------------------------------------- */
const updateCurrentDate = () => {
    $('#currentDate').text(moment().format('dddd, D MMMM YYYY – HH:mm'));
};

/* ---------------------------------------------------------
   11. MODAL ADMIN
--------------------------------------------------------- */
$('#adminAccess').on('click', () => $('#adminModal').fadeIn());
$('.close-admin-modal').on('click', () => $('#adminModal').fadeOut());

/* ---------------------------------------------------------
   12. DATE RANGE PICKER
--------------------------------------------------------- */
$('#transactionDateRange, #reportDateRange').daterangepicker({
    locale: { format: 'DD/MM/YYYY' }
}, function (start, end) {
    loadAdminTransactions(start, end);
    loadSalesReport(start, end);
});

/* ---------------------------------------------------------
   13. INITIALIZE
--------------------------------------------------------- */
loadProducts();
loadCategoryDropdown();
updateCart();
loadSettingsUI();
updateCurrentDate();
</script>

    <!-- =========================================================
     BAGIAN 3 – MODAL CRUD SEMUA DATA + IMPORT/EXPORT + BACKUP
     ========================================================= -->

<!-- Modal Tambah/Edit Produk -->
<div id="productModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="productModalTitle">Tambah Produk</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="productId">
            <div class="form-group">
                <label>Barcode</label>
                <input type="text" id="productBarcode" class="form-control">
            </div>
            <div class="form-group">
                <label>Nama Produk</label>
                <input type="text" id="productName" class="form-control">
            </div>
            <div class="form-group">
                <label>Merk</label>
                <input type="text" id="productBrand" class="form-control">
            </div>
            <div class="form-group">
                <label>Satuan</label>
                <input type="text" id="productUnit" class="form-control">
            </div>
            <div class="form-group">
                <label>Kategori</label>
                <select id="productCategoryModal" class="form-control"></select>
            </div>
            <div class="form-group">
                <label>Harga</label>
                <input type="number" id="productPrice" class="form-control" min="0">
            </div>
            <div class="form-group">
                <label>Stok</label>
                <input type="number" id="productStock" class="form-control" min="0">
            </div>
            <div class="form-group">
                <label>Deskripsi</label>
                <textarea id="productDescription" class="form-control" rows="3"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary close-modal">Batal</button>
            <button class="btn btn-success" id="saveProductBtn">Simpan</button>
        </div>
    </div>
</div>

<!-- Modal Tambah/Edit Kategori -->
<div id="categoryModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="categoryModalTitle">Tambah Kategori</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="categoryId">
            <div class="form-group">
                <label>Nama Kategori</label>
                <input type="text" id="categoryName" class="form-control">
            </div>
            <div class="form-group">
                <label>Deskripsi</label>
                <textarea id="categoryDescription" class="form-control" rows="3"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary close-modal">Batal</button>
            <button class="btn btn-success" id="saveCategoryBtn">Simpan</button>
        </div>
    </div>
</div>

<!-- Modal Tambah/Edit Pelanggan -->
<div id="customerModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="customerModalTitle">Tambah Pelanggan</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="customerId">
            <div class="form-group">
                <label>Tipe</label>
                <select id="customerTypeModal" class="form-control">
                    <option value="walkin">Biasa</option>
                    <option value="member">Member</option>
                </select>
            </div>
            <div class="form-group">
                <label>Nama Lengkap</label>
                <input type="text" id="customerNameModal" class="form-control">
            </div>
            <div class="form-group">
                <label>No. Telepon</label>
                <input type="tel" id="customerPhoneModal" class="form-control">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="customerEmailModal" class="form-control">
            </div>
            <div class="form-group">
                <label>Alamat</label>
                <textarea id="customerAddressModal" class="form-control" rows="3"></textarea>
            </div>
            <div class="form-group" id="pointsField" style="display:none;">
                <label>Poin Loyalty</label>
                <input type="number" id="customerPointsModal" class="form-control" min="0">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary close-modal">Batal</button>
            <button class="btn btn-success" id="saveCustomerBtn">Simpan</button>
        </div>
    </div>
</div>

<!-- Modal Tambah/Edit Kasir -->
<div id="cashierModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="cashierModalTitle">Tambah Kasir</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="cashierId">
            <div class="form-group">
                <label>Nama Lengkap</label>
                <input type="text" id="cashierNameModal" class="form-control">
            </div>
            <div class="form-group">
                <label>PIN (4 digit)</label>
                <input type="password" id="cashierPinModal" class="form-control" maxlength="4">
            </div>
            <div class="form-group">
                <label>Role</label>
                <select id="cashierRoleModal" class="form-control">
                    <option value="cashier">Kasir</option>
                    <option value="admin">Admin</option>
                    <option value="gudang">Gudang</option>
                </select>
            </div>
            <div class="form-group">
                <label>Status</label>
                <select id="cashierStatusModal" class="form-control">
                    <option value="active">Aktif</option>
                    <option value="inactive">Nonaktif</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary close-modal">Batal</button>
            <button class="btn btn-success" id="saveCashierBtn">Simpan</button>
        </div>
    </div>
</div>

<!-- Modal Detail Transaksi -->
<div id="transactionDetailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Detail Transaksi</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <div id="transactionDetailContent"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" id="printReceiptBtn"><i class="fas fa-print"></i> Cetak</button>
            <button class="btn btn-secondary close-modal">Tutup</button>
        </div>
    </div>
</div>

<!-- =========================================================
     JAVASCRIPT CRUD + IMPORT/EXPORT + BACKUP
     ========================================================= -->
<script>
/* ---------------------------------------------------------
   1. OPEN MODAL TAMBAH / EDIT
--------------------------------------------------------- */
$('#addProduct').click(() => openProductModal());
$('#addCategory').click(() => openCategoryModal());
$('#addCustomer').click(() => openCustomerModal());
$('#addCashier').click(() => openCashierModal());

/* ---------------------------------------------------------
   2. PRODUK
--------------------------------------------------------- */
const openProductModal = (id = null) => {
    loadCategoryOptions('#productCategoryModal');
    if (id) {
        const p = products.find(x => x.id === id);
        $('#productModalTitle').text('Edit Produk');
        $('#productId').val(p.id);
        $('#productBarcode').val(p.barcode);
        $('#productName').val(p.name);
        $('#productBrand').val(p.brand);
        $('#productUnit').val(p.unit);
        $('#productCategoryModal').val(p.categoryId);
        $('#productPrice').val(p.price);
        $('#productStock').val(p.stock);
        $('#productDescription').val(p.description || '');
    } else {
        $('#productModalTitle').text('Tambah Produk');
        $('#productId').val('');
        $('#productForm').trigger('reset');
    }
    $('#productModal').fadeIn();
};

$('#saveProductBtn').click(() => {
    const id = $('#productId').val();
    const data = {
        barcode: $('#productBarcode').val(),
        name: $('#productName').val(),
        brand: $('#productBrand').val(),
        unit: $('#productUnit').val(),
        categoryId: $('#productCategoryModal').val(),
        price: Number($('#productPrice').val()),
        stock: Number($('#productStock').val()),
        description: $('#productDescription').val()
    };

    if (!data.name || !data.barcode || data.price <= 0) {
        showToast('Lengkapi nama, barcode, dan harga', 'error');
        return;
    }

    if (id) {
        const idx = products.findIndex(p => p.id === id);
        products[idx] = { ...products[idx], ...data };
        showToast('Produk diperbarui', 'success');
    } else {
        products.push({ id: 'P' + Date.now(), ...data });
        showToast('Produk ditambahkan', 'success');
    }
    saveAll();
    loadProducts();
    loadAdminProducts();
    $('#productModal').fadeOut();
});

/* ---------------------------------------------------------
   3. KATEGORI
--------------------------------------------------------- */
const openCategoryModal = (id = null) => {
    if (id) {
        const c = categories.find(x => x.id === id);
        $('#categoryModalTitle').text('Edit Kategori');
        $('#categoryId').val(c.id);
        $('#categoryName').val(c.name);
        $('#categoryDescription').val(c.description);
    } else {
        $('#categoryModalTitle').text('Tambah Kategori');
        $('#categoryForm').trigger('reset');
    }
    $('#categoryModal').fadeIn();
};

$('#saveCategoryBtn').click(() => {
    const id = $('#categoryId').val();
    const data = {
        name: $('#categoryName').val(),
        description: $('#categoryDescription').val()
    };
    if (!data.name) return showToast('Nama kategori harus diisi', 'error');

    if (id) {
        const idx = categories.findIndex(c => c.id === id);
        categories[idx] = { ...categories[idx], ...data };
    } else {
        categories.push({ id: 'C' + Date.now(), ...data });
    }
    saveAll();
    loadCategoryDropdown();
    loadAdminCategories();
    $('#categoryModal').fadeOut();
});

/* ---------------------------------------------------------
   4. PELANGGAN
--------------------------------------------------------- */
const openCustomerModal = (id = null) => {
    if (id) {
        const c = customers.find(x => x.id === id);
        $('#customerModalTitle').text('Edit Pelanggan');
        $('#customerId').val(c.id);
        $('#customerNameModal').val(c.name);
        $('#customerPhoneModal').val(c.phone);
        $('#customerEmailModal').val(c.email);
        $('#customerAddressModal').val(c.address);
        $('#customerTypeModal').val(c.type);
        $('#customerPointsModal').val(c.points || 0);
        $('#pointsField').toggle(c.type === 'member');
    } else {
        $('#customerModalTitle').text('Tambah Pelanggan');
        $('#customerForm').trigger('reset');
        $('#pointsField').hide();
    }
    $('#customerModal').fadeIn();
};

$('#customerTypeModal').on('change', function () {
    $('#pointsField').toggle($(this).val() === 'member');
});

$('#saveCustomerBtn').click(() => {
    const id = $('#customerId').val();
    const data = {
        name: $('#customerNameModal').val(),
        phone: $('#customerPhoneModal').val(),
        email: $('#customerEmailModal').val(),
        address: $('#customerAddressModal').val(),
        type: $('#customerTypeModal').val(),
        points: Number($('#customerPointsModal').val()) || 0
    };
    if (!data.name || !data.phone) return showToast('Nama & telepon wajib', 'error');

    if (id) {
        const idx = customers.findIndex(c => c.id === id);
        customers[idx] = { ...customers[idx], ...data };
    } else {
        customers.push({ id: 'M' + Date.now(), ...data });
    }
    saveAll();
    loadAdminCustomers();
    $('#customerModal').fadeOut();
});

/* ---------------------------------------------------------
   5. KASIR
--------------------------------------------------------- */
const openCashierModal = (id = null) => {
    if (id) {
        const c = cashiers.find(x => x.id === id);
        $('#cashierModalTitle').text('Edit Kasir');
        $('#cashierId').val(c.id);
        $('#cashierNameModal').val(c.name);
        $('#cashierPinModal').val(c.pin);
        $('#cashierRoleModal').val(c.role);
        $('#cashierStatusModal').val(c.status);
    } else {
        $('#cashierModalTitle').text('Tambah Kasir');
        $('#cashierForm').trigger('reset');
    }
    $('#cashierModal').fadeIn();
};

$('#saveCashierBtn').click(() => {
    const id = $('#cashierId').val();
    const data = {
        name: $('#cashierNameModal').val(),
        pin: $('#cashierPinModal').val(),
        role: $('#cashierRoleModal').val(),
        status: $('#cashierStatusModal').val()
    };
    if (!data.name || data.pin.length !== 4) return showToast('PIN harus 4 digit', 'error');

    if (id) {
        const idx = cashiers.findIndex(c => c.id === id);
        cashiers[idx] = { ...cashiers[idx], ...data };
    } else {
        cashiers.push({ id: 'K' + (cashiers.length + 1).toString().padStart(3, '0'), ...data });
    }
    saveAll();
    loadAdminCashiers();
    $('#cashierModal').fadeOut();
});

/* ---------------------------------------------------------
   6. HAPUS DATA
--------------------------------------------------------- */
$(document).on('click', '.delete-product', function () {
    const id = $(this).data('id');
    showConfirmation('Hapus produk?', confirmed => {
        if (confirmed) {
            products = products.filter(p => p.id !== id);
            saveAll();
            loadProducts();
            loadAdminProducts();
            showToast('Produk dihapus', 'info');
        }
    });
});

$(document).on('click', '.delete-category', function () {
    const id = $(this).data('id');
    if (products.some(p => p.categoryId === id)) {
        showToast('Kategori sedang digunakan', 'error');
        return;
    }
    showConfirmation('Hapus kategori?', confirmed => {
        if (confirmed) {
            categories = categories.filter(c => c.id !== id);
            saveAll();
            loadCategoryDropdown();
            loadAdminCategories();
            showToast('Kategori dihapus', 'info');
        }
    });
});

$(document).on('click', '.delete-customer', function () {
    const id = $(this).data('id');
    showConfirmation('Hapus pelanggan?', confirmed => {
        if (confirmed) {
            customers = customers.filter(c => c.id !== id);
            saveAll();
            loadAdminCustomers();
            showToast('Pelanggan dihapus', 'info');
        }
    });
});

$(document).on('click', '.delete-cashier', function () {
    const id = $(this).data('id');
    if (currentCashier && currentCashier.id === id) {
        showToast('Tidak bisa hapus diri sendiri', 'error');
        return;
    }
    showConfirmation('Hapus kasir?', confirmed => {
        if (confirmed) {
            cashiers = cashiers.filter(c => c.id !== id);
            saveAll();
            loadAdminCashiers();
            showToast('Kasir dihapus', 'info');
        }
    });
});

/* ---------------------------------------------------------
   7. IMPORT PRODUK EXCEL
--------------------------------------------------------- */
$('#importProductBtn').click(() => $('#importProductFile').click());
$('#importProductFile').on('change', function (e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function (ev) {
        const wb = XLSX.read(ev.target.result, { type: 'binary' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
        rows.slice(1).forEach(r => {
            const [barcode, name, brand, unit, categoryName, price, stock] = r;
            if (!barcode || !name) return;
            if (!products.find(p => p.barcode == barcode)) {
                let cat = categories.find(c => c.name === categoryName);
                if (!cat) {
                    cat = { id: 'C' + Date.now(), name: categoryName, description: '' };
                    categories.push(cat);
                }
                products.push({
                    id: 'P' + Date.now(),
                    barcode, name, brand, unit,
                    categoryId: cat.id,
                    price: Number(price),
                    stock: Number(stock)
                });
            }
        });
        saveAll();
        loadProducts();
        loadCategoryDropdown();
        loadAdminProducts();
        showToast('Produk diimport', 'success');
    };
    reader.readAsBinaryString(file);
});

/* ---------------------------------------------------------
   8. EXPORT & BACKUP / RESTORE
--------------------------------------------------------- */
$('#exportReportExcel').click(() => {
    const ws = XLSX.utils.json_to_sheet(transactions.map(t => ({
        ID: t.id,
        Tanggal: moment(t.date).format('DD/MM/YYYY HH:mm'),
        Total: t.total,
        Kasir: t.cashier.name
    })));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Transaksi');
    XLSX.writeFile(wb, 'Laporan_Transaksi.xlsx');
});

$('#backupData').click(() => {
    const blob = new Blob([JSON.stringify({
        products, categories, customers, cashiers, transactions, settings
    }, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `POS_Backup_${moment().format('YYYYMMDD_HHmmss')}.json`;
    a.click();
    showToast('Backup berhasil', 'success');
});

$('#restoreData').click(() => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = ev => {
            try {
                const data = JSON.parse(ev.target.result);
                products = data.products || [];
                categories = data.categories || [];
                customers = data.customers || [];
                cashiers = data.cashiers || [];
                transactions = data.transactions || [];
                settings = data.settings || {};
                saveAll();
                loadProducts();
                loadCategoryDropdown();
                loadAdminData();
                showToast('Data dipulihkan', 'success');
            } catch {
                showToast('File rusak', 'error');
            }
        };
        reader.readAsText(file);
    };
    input.click();
});

/* ---------------------------------------------------------
   9. DETAIL & CETAK STRUK
--------------------------------------------------------- */
$(document).on('click', '.view-transaction', function () {
    const id = $(this).data('id');
    const tx = transactions.find(t => t.id === id);
    if (!tx) return;
    $('#transactionDetailContent').html(`
        <div class="receipt">
            <div style="text-align:center;">
                ${settings.storeLogo ? `<img src="${settings.storeLogo}" style="max-width:80px"><br>` : ''}
                <h3>${settings.storeName}</h3>
                <p>${settings.storeAddress}<br>${settings.storePhone}</p>
                <p>${moment(tx.date).format('DD/MM/YYYY HH:mm')}</p>
            </div>
            <table style="width:100%;">
                ${tx.items.map(i => `<tr><td>${i.product.name} (${i.quantity})</td><td style="text-align:right">${formatCurrency(i.product.price * i.quantity)}</td></tr>`).join('')}
            </table>
            <hr>
            <div style="text-align:right">
                Subtotal: ${formatCurrency(tx.subtotal)}<br>
                Diskon: ${formatCurrency(tx.discount)}<br>
                Pajak: ${formatCurrency(tx.tax)}<br>
                <strong>Total: ${formatCurrency(tx.total)}</strong><br>
                Tunai: ${formatCurrency(tx.paymentAmount)}<br>
                Kembali: ${formatCurrency(tx.change)}
            </div>
            <div style="text-align:center;font-size:.8em;margin-top:10px;">Terima kasih!</div>
        </div>
    `);
    $('#transactionDetailModal').fadeIn();
});

$('#printReceiptBtn').click(() => window.print());

/* ---------------------------------------------------------
   10. KONFIRMASI HAPUS
--------------------------------------------------------- */
const showConfirmation = (msg, callback) => {
    if (confirm(msg)) callback(true);
};

/* ---------------------------------------------------------
   11. LOAD SEMUA DATA ADMIN AWAL
--------------------------------------------------------- */
const loadAdminData = () => {
    loadAdminProducts();
    loadAdminCategories();
    loadAdminCustomers();
    loadAdminCashiers();
    loadAdminTransactions();
};

const loadCategoryOptions = selector => {
    $(selector).empty().append('<option value="">Pilih Kategori</option>');
    categories.forEach(c => $(selector).append(`<option value="${c.id}">${c.name}</option>`));
};

/* ---------------------------------------------------------
   12. EDIT BUTTON TRIGGER
--------------------------------------------------------- */
$(document).on('click', '.edit-product', function () {
    openProductModal($(this).data('id'));
});
$(document).on('click', '.edit-category', function () {
    openCategoryModal($(this).data('id'));
});
$(document).on('click', '.edit-customer', function () {
    openCustomerModal($(this).data('id'));
});
$(document).on('click', '.edit-cashier', function () {
    openCashierModal($(this).data('id'));
});

/* ---------------------------------------------------------
   13. CLOSE MODAL
--------------------------------------------------------- */
$(document).on('click', '.close-modal, .modal-close', function () {
    $(this).closest('.modal').fadeOut();
});
</script>

    <!-- =========================================================
     BAGIAN 4 – PRINT ESC/POS, CLOUD SYNC, QR, SPLIT PAYMENT, DLL
     ========================================================= -->

<!-- Modal Split Payment / DP / Hutang -->
<div id="splitPaymentModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3>Pembayaran Ganda / DP / Hutang</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Total Tagihan</label>
                <input type="text" id="splitTotal" class="form-control" readonly>
            </div>
            <div id="splitRows">
                <div class="split-row" style="display:flex;gap:10px;margin-bottom:10px">
                    <select class="form-control splitMethod">
                        <option value="cash">Tunai</option>
                        <option value="transfer">Transfer</option>
                        <option value="ewallet">E-Wallet</option>
                        <option value="debt">Hutang</option>
                    </select>
                    <input type="number" class="form-control splitAmount" placeholder="Jumlah" min="0">
                    <button class="btn btn-danger btn-sm removeSplit" style="display:none"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <button class="btn btn-outline-primary btn-sm" id="addSplitRow">+ Tambah Metode</button>
            <hr>
            <div class="summary-row"><span>Sisa / Kembali</span><span id="splitChange">Rp 0</span></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary close-modal">Batal</button>
            <button class="btn btn-success" id="confirmSplitBtn">Selesaikan</button>
        </div>
    </div>
</div>

<!-- Modal Pilih Bahasa -->
<div id="languageModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3>Pilih Bahasa</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body text-center">
            <button class="btn btn-outline-primary btn-block" onclick="setLanguage('id')">🇮🇩 Indonesia</button>
            <button class="btn btn-outline-primary btn-block" onclick="setLanguage('en')">🇬🇧 English</button>
        </div>
    </div>
</div>

<!-- ESC/POS Print Helper -->
<script src="https://cdn.jsdelivr.net/npm/esc-pos-encoder@2.0.0/dist/esc-pos-encoder.min.js"></script>

<script>
/* ---------------------------------------------------------
   1. MULTI-BAHASA
--------------------------------------------------------- */
const lang = {
    id: {
        loginTitle: 'Premium POS – Login',
        cashier: 'Kasir',
        product: 'Produk',
        category: 'Kategori',
        customer: 'Pelanggan',
        transaction: 'Transaksi',
        settings: 'Pengaturan',
        holdBill: 'Tahan Bill',
        completePayment: 'Selesai & Cetak',
        total: 'Total',
        payAmount: 'Jumlah Bayar',
        change: 'Kembali',
        success: 'Sukses',
        error: 'Error'
    },
    en: {
        loginTitle: 'Premium POS – Login',
        cashier: 'Cashier',
        product: 'Product',
        category: 'Category',
        customer: 'Customer',
        transaction: 'Transaction',
        settings: 'Settings',
        holdBill: 'Hold Bill',
        completePayment: 'Finish & Print',
        total: 'Total',
        payAmount: 'Pay Amount',
        change: 'Change',
        success: 'Success',
        error: 'Error'
    }
};

let currentLang = localStorage.getItem('lang') || 'id';

const setLanguage = (l) => {
    currentLang = l;
    localStorage.setItem('lang', l);
    applyLanguage();
    $('#languageModal').fadeOut();
    showToast(lang[l].success, 'success');
};

const applyLanguage = () => {
    const l = lang[currentLang];
    $('#storeName').text(l.loginTitle);
    // Anda bisa expand ke seluruh teks statis di HTML
};

/* ---------------------------------------------------------
   2. SPLIT PAYMENT / DP / HUTANG
--------------------------------------------------------- */
let splitTotal = 0;
let splitPayments = [];

$('#completePayment').on('click', function () {
    const total = currentCart.total;
    if (total <= 0) return showToast(lang[currentLang].error, 'error');
    splitTotal = total;
    $('#splitTotal').val(formatCurrency(total));
    $('#splitRows').empty().append(`
        <div class="split-row" style="display:flex;gap:10px;margin-bottom:10px">
            <select class="form-control splitMethod"><option value="cash">Tunai</option><option value="transfer">Transfer</option><option value="ewallet">E-Wallet</option><option value="debt">Hutang</option></select>
            <input type="number" class="form-control splitAmount" placeholder="Jumlah" min="0">
            <button class="btn btn-danger btn-sm removeSplit" style="display:none"><i class="fas fa-times"></i></button>
        </div>
    `);
    $('#splitChange').text('Rp 0');
    $('#splitPaymentModal').fadeIn();
});

$(document).on('click', '#addSplitRow', function () {
    $('#splitRows').append(`
        <div class="split-row" style="display:flex;gap:10px;margin-bottom:10px">
            <select class="form-control splitMethod"><option value="cash">Tunai</option><option value="transfer">Transfer</option><option value="ewallet">E-Wallet</option><option value="debt">Hutang</option></select>
            <input type="number" class="form-control splitAmount" placeholder="Jumlah" min="0">
            <button class="btn btn-danger btn-sm removeSplit"><i class="fas fa-times"></i></button>
        </div>
    `);
});

$(document).on('click', '.removeSplit', function () {
    $(this).closest('.split-row').remove();
    recalculateSplit();
});

$(document).on('input', '.splitAmount', recalculateSplit);

function recalculateSplit() {
    let totalPaid = 0;
    $('.splitAmount').each(function () {
        totalPaid += Number($(this).val()) || 0;
    });
    $('#splitChange').text(formatCurrency(totalPaid - splitTotal));
}

$('#confirmSplitBtn').click(function () {
    let totalPaid = 0;
    splitPayments = [];
    $('.split-row').each(function () {
        const method = $(this).find('.splitMethod').val();
        const amount = Number($(this).find('.splitAmount').val()) || 0;
        totalPaid += amount;
        splitPayments.push({ method, amount });
    });
    if (totalPaid < splitTotal) {
        showToast('Jumlah belum cukup', 'error');
        return;
    }
    finalizeTransaction(splitPayments, totalPaid - splitTotal);
    $('#splitPaymentModal').fadeOut();
});

const finalizeTransaction = (payments, change) => {
    const tx = {
        id: 'TX' + Date.now(),
        date: new Date(),
        items: currentCart.items,
        customer: currentCart.customer,
        subtotal: currentCart.subtotal,
        discount: currentCart.discount,
        tax: currentCart.tax,
        total: currentCart.total,
        payments,
        change,
        cashier: currentCashier
    };
    transactions.unshift(tx);
    tx.items.forEach(i => {
        const p = products.find(prod => prod.id === i.product.id);
        if (p) p.stock -= i.quantity;
    });
    saveAll();
    generateReceipt(tx);
    printToThermal(tx);
    resetCart();
    showToast(lang[currentLang].success, 'success');
};

/* ---------------------------------------------------------
   3. ESC/POS THERMAL PRINTER
--------------------------------------------------------- */
const printToThermal = (tx) => {
    try {
        const encoder = new EscPosEncoder();
        let result = encoder
            .initialize()
            .align('center')
            .size(2, 2)
            .text(settings.storeName + '\n')
            .size(1, 1)
            .text(settings.storeAddress + '\n')
            .text(moment(tx.date).format('DD/MM/YYYY HH:mm') + '\n')
            .align('left');
        tx.items.forEach(i => {
            result = result
                .text(`${i.product.name} (${i.quantity}x)\n`)
                .align('right')
                .text(formatCurrency(i.product.price * i.quantity) + '\n');
        });
        result = result
            .align('left')
            .line()
            .align('right')
            .text(`Total: ${formatCurrency(tx.total)}\n`)
            .text(`Bayar: ${formatCurrency(tx.payments.reduce((a, p) => a + p.amount, 0))}\n`)
            .text(`Kembali: ${formatCurrency(tx.change)}\n`)
            .align('center')
            .text('Terima kasih!\n')
            .qr('https://qr.link/' + tx.id, 5)
            .newline();
        // Kirim ke printer via WebUSB atau WebSerial (mock)
        console.log('Thermal print buffer:', result.encode());
        showToast('Thermal print dikirim', 'info');
    } catch (e) {
        console.error(e);
    }
};

/* ---------------------------------------------------------
   4. QR CODE GENERATOR
--------------------------------------------------------- */
const generateQR = (text) => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const qr = new QRCode(ctx, {
        text,
        width: 128,
        height: 128,
        colorDark: '#000',
        colorLight: '#fff'
    });
    return canvas.toDataURL();
};

/* ---------------------------------------------------------
   5. AUTO CLOUD SYNC (MOCK)
--------------------------------------------------------- */
const syncToCloud = () => {
    const payload = {
        store: store.id,
        products, categories, customers, transactions
    };
    console.log('Syncing to cloud...', payload);
    // fetch('https://api.example.com/sync', { method: 'POST', body: JSON.stringify(payload) })
    // .then(r => r.ok ? showToast('Sync OK', 'success') : showToast('Sync failed', 'error'));
};

setInterval(syncToCloud, 300000); // Auto sync 5 menit

/* ---------------------------------------------------------
   6. STYLING PRINT
--------------------------------------------------------- */
<style>
@media print {
    body * { visibility: hidden; }
    .receipt, .receipt * { visibility: visible; }
    .receipt {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        max-width: 100%;
        box-shadow: none;
        padding: 10px;
        font-size: 12px;
    }
}
</style>

/* ---------------------------------------------------------
   7. LANGUAGE BUTTON
--------------------------------------------------------- */
$('#languageBtn').click(() => $('#languageModal').fadeIn());
</script>
</body>
</html>
    
