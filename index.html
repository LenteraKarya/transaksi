<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Premium-POS-Final 2025-07-18</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="description" content="Offline-POS with barcode scan, PWA, dark-mode, printer, promo engine">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root{
  --primary:#4361ee; --secondary:#3f37c9; --success:#10b981; --danger:#ef4444;
  --warning:#f59e0b; --info:#3b82f6; --dark:#1a1a2e; --light:#f5f7fa;
  --radius:.5rem; --shadow:0 4px 6px -1px rgba(0,0,0,.1);
}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif}
body{background:var(--light);color:#333;line-height:1.6}
body.dark{--light:#111;--dark:#f5f5f5;background:#111;color:#f5f5f5}
.container{max-width:100%;margin:0 auto;padding:20px}
.header{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:15px 20px;border-radius:var(--radius);margin-bottom:20px;display:flex;justify-content:space-between;align-items:center}
.header h1{font-size:1.8rem;font-weight:600}
.header-info{text-align:right;font-size:.9rem}
.main-content{display:flex;flex-wrap:wrap;gap:20px}
.left-panel,.right-panel{flex:1 1 300px;background:#fff;border-radius:var(--radius);padding:20px;box-shadow:var(--shadow)}
body.dark .left-panel,body.dark .right-panel{background:#1e1e2f;color:#f5f5f5}
.panel-title{font-size:1.2rem;margin-bottom:15px;border-bottom:2px solid var(--primary);padding-bottom:5px;font-weight:600}
.form-group{margin-bottom:15px}
.form-group label{display:block;margin-bottom:5px;font-weight:500}
.form-control{width:100%;padding:10px;border:1px solid #ddd;border-radius:.25rem;transition:.3s;background:#fff;color:#333}
body.dark .form-control{background:#2a2a40;border-color:#444;color:#f5f5f5}
.btn{display:inline-block;padding:10px 20px;background:var(--primary);color:#fff;border:none;border-radius:.25rem;cursor:pointer;font-size:1rem;transition:.3s}
.btn:hover{transform:translateY(-2px)}
.btn-block{width:100%}
.btn-success{background:var(--success)} .btn-danger{background:var(--danger)} .btn-warning{background:var(--warning)}
.table-responsive{overflow-x:auto;border-radius:.25rem;box-shadow:var(--shadow)}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:12px 15px;text-align:left;border-bottom:1px solid #ddd}
.table th{background:#f1f3f5;position:sticky;top:0}
body.dark .table th{background:#2a2a40}
.cart-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #eee}
.cart-item-info{flex:1}
.cart-summary{margin-top:20px;padding-top:15px;border-top:2px dashed #ddd}
.summary-row{display:flex;justify-content:space-between;margin-bottom:10px}
.total-row{font-size:1.1rem;color:var(--primary);margin-top:10px;border-top:1px solid #ddd}
.tabs{display:flex;border-bottom:1px solid #ddd;margin-bottom:20px}
.tab{padding:10px 20px;cursor:pointer;border-bottom:2px solid transparent}
.tab.active{border-color:var(--primary);color:var(--primary);font-weight:500}
.tab-content{display:none;animation:fadeIn .3s}
.tab-content.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000;justify-content:center;align-items:center}
.modal-content{background:#fff;border-radius:var(--radius);width:90%;max-width:800px;max-height:90vh;overflow-y:auto;padding:0}
body.dark .modal-content{background:#1e1e2f;color:#f5f5f5}
.modal-header{padding:15px 20px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
.modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;color:#999}
.modal-body{padding:20px}
.modal-footer{padding:15px 20px;border-top:1px solid #eee;display:flex;justify-content:flex-end;gap:10px}
.login-container{max-width:400px;margin:50px auto;background:#fff;border-radius:var(--radius);padding:40px;box-shadow:0 20px 25px -5px rgba(0,0,0,.1)}
body.dark .login-container{background:#1e1e2f;color:#f5f5f5}
.login-logo{text-align:center;margin-bottom:20px}
.login-logo i{font-size:3rem;color:var(--primary);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.receipt{background:#fff;padding:20px;font-family:'Courier New',monospace;max-width:300px;margin:0 auto;box-shadow:var(--shadow);font-size:14px}
body.dark .receipt{background:#1e1e2f;color:#f5f5f5}
.receipt-header{text-align:center;margin-bottom:15px}
.receipt-title{font-weight:bold;font-size:1.2rem;margin-bottom:5px}
.receipt-address{font-size:.8rem;margin-bottom:5px}
.receipt-date{font-size:.8rem;margin-bottom:10px}
.receipt-items{margin-bottom:15px}
.receipt-item{display:flex;justify-content:space-between;margin-bottom:5px;font-size:.9rem}
.receipt-total{border-top:1px dashed #000;padding-top:10px;margin-top:10px;font-weight:bold}
.receipt-footer{text-align:center;margin-top:15px;font-size:.8rem}
.badge{display:inline-block;padding:3px 8px;border-radius:20px;font-size:.75rem;font-weight:500;text-transform:uppercase}
.badge-success{background:#d1fae5;color:#065f46}
.empty-state{text-align:center;padding:30px;color:#666}
.empty-state i{font-size:3rem;color:#ddd;margin-bottom:15px}
.fab{position:fixed;bottom:20px;right:20px;width:56px;height:56px;border-radius:50%;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow);cursor:pointer;z-index:100}
.fab i{font-size:1.5rem}
.toast{position:fixed;top:20px;right:20px;padding:15px 20px;background:#333;color:#fff;border-radius:.25rem;z-index:1100;display:flex;align-items:center;transform:translateX(200%);transition:.3s}
.toast.show{transform:translateX(0)}
.toast.success{background:var(--success)}
.toast.error{background:var(--danger)}
.toast i{margin-right:10px}
.spinner{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s linear infinite;margin-right:10px}
@keyframes spin{to{transform:rotate(360deg)}}
.password-toggle{position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;color:#999}
.theme-toggle{position:absolute;top:20px;right:20px;background:none;border:none;font-size:1.5rem;cursor:pointer;z-index:999}
.qr-video{width:100%;max-width:300px;border-radius:var(--radius)}
@media print{body *{visibility:hidden}.receipt,.receipt *{visibility:visible}.receipt{position:absolute;left:0;top:0;width:100%;max-width:100%;box-shadow:none;margin:0;font-size:14px}}
@media(max-width:768px){.main-content{flex-direction:column}.left-panel,.right-panel{min-width:100%}.header{flex-direction:column;text-align:center}.header-info{text-align:center;margin-top:10px}}
</style>
</head>
<body>
<button class="theme-toggle" id="themeToggle" title="Toggle dark mode"><i class="fas fa-moon"></i></button>

<!-- Toast -->
<div id="toast" class="toast"><i class="fas fa-info-circle"></i><span id="toastMsg">Notification</span></div>

<!-- Login -->
<div id="loginModal" class="modal" style="display:flex">
  <div class="login-container">
    <div class="login-logo"><i class="fas fa-cash-register"></i></div>
    <h2 class="login-title">Premium POS</h2>
    <form id="loginForm">
      <div class="form-group">
        <input class="form-control" id="cashierId" placeholder="ID Kasir" required>
      </div>
      <div class="form-group">
        <input type="password" class="form-control" id="cashierPin" placeholder="PIN 4 digit" maxlength="4" required>
      </div>
      <button class="btn btn-block">Login</button>
    </form>
  </div>
</div>

<!-- Main App -->
<div id="mainApp" style="display:none">
  <div class="container">
    <div class="header">
      <div>
        <h1 id="storeName">Premium POS System</h1>
        <p id="storeAddress">Jl. Contoh No. 123, Kota Contoh</p>
      </div>
      <div class="header-info">
        <p id="currentDate">-</p>
        <p>Kasir: <span id="loggedInCashier">-</span> | <a href="#" id="logoutBtn" style="color:#fff">Logout</a></p>
      </div>
    </div>

    <div class="main-content">
      <!-- LEFT -->
      <div class="left-panel">
        <h2 class="panel-title">Produk</h2>
        <div class="form-group">
          <input class="form-control" id="productSearch" placeholder="Cari produk / scan barcode...">
        </div>
        <div class="form-group">
          <select class="form-control" id="productCategory"><option value="all">Semua Kategori</option></select>
        </div>
        <div class="table-responsive">
          <table class="table">
            <thead><tr><th>Nama</th><th>Harga</th><th>Stok</th><th>Aksi</th></tr></thead>
            <tbody id="productListBody"></tbody>
          </table>
        </div>
        <!-- Barcode Scanner Live -->
        <div id="scanner" style="display:none">
          <video id="qrVideo" class="qr-video" autoplay playsinline></video>
          <button class="btn btn-sm btn-danger" onclick="stopScan()">Tutup Scanner</button>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="right-panel">
        <h2 class="panel-title">Transaksi</h2>
        <div class="tabs">
          <div class="tab active" data-tab="cart">Keranjang</div>
          <div class="tab" data-tab="customer">Pelanggan</div>
          <div class="tab" data-tab="payment">Pembayaran</div>
        </div>

        <div class="tab-content active" id="cartTab">
          <div id="cartItems"></div>
          <div class="cart-summary">
            <div class="summary-row"><span>Subtotal:</span><span id="cartSubtotal">Rp 0</span></div>
            <div class="summary-row"><span>Diskon:</span><span id="cartDiscount">Rp 0</span></div>
            <div class="summary-row"><span>Pajak:</span><span id="cartTax">Rp 0</span></div>
            <div class="summary-row total-row"><span>Total:</span><span id="cartTotal">Rp 0</span></div>
          </div>
          <button id="nextToCustomer" class="btn btn-primary btn-block mt-3">Lanjut ke Pelanggan</button>
        </div>

        <div class="tab-content" id="customerTab">
          <div class="form-group">
            <label>Tipe Pelanggan</label>
            <select class="form-control" id="customerType">
              <option value="walkin">Pelanggan Biasa</option>
              <option value="member">Member</option>
            </select>
          </div>
          <div id="memberFields" style="display:none">
            <div class="form-group"><label>ID Member</label><input class="form-control" id="memberId"></div>
            <div class="form-group"><label>Diskon Member (%)</label><input type="number" id="memberDiscount" value="10"></div>
          </div>
          <div id="customerFields" style="display:none">
            <div class="form-group"><label>Nama Pelanggan</label><input class="form-control" id="customerName"></div>
            <div class="form-group"><label>No. Telepon</label><input class="form-control" id="customerPhone"></div>
            <div class="form-group"><label>Email (opsional)</label><input class="form-control" id="customerEmail"></div>
          </div>
          <div class="buttons mt-3">
            <button id="backToCart" class="btn btn-warning">Kembali</button>
            <button id="nextToPayment" class="btn btn-primary float-right">Lanjut ke Pembayaran</button>
          </div>
        </div>

        <div class="tab-content" id="paymentTab">
          <div class="cart-summary">
            <div class="summary-row"><span>Subtotal:</span><span id="paymentSubtotal">Rp 0</span></div>
            <div class="summary-row"><span>Diskon:</span><span id="paymentDiscount">Rp 0</span></div>
            <div class="summary-row"><span>Pajak:</span><span id="paymentTax">Rp 0</span></div>
            <div class="summary-row total-row"><span>Total:</span><span id="paymentTotal">Rp 0</span></div>
          </div>
          <div class="form-group"><label>Jumlah Pembayaran</label><input type="number" id="paymentAmount" class="form-control" placeholder="Masukkan jumlah"></div>
          <div class="form-group"><label>Metode Pembayaran</label>
            <div class="payment-method"><input type="radio" name="paymentMethod" value="cash" checked><label>Tunai</label></div>
            <div class="payment-method"><input type="radio" name="paymentMethod" value="transfer"><label>Transfer Bank</label></div>
            <div class="payment-method"><input type="radio" name="paymentMethod" value="ewallet"><label>E-Wallet</label></div>
          </div>
          <div class="buttons mt-3">
            <button id="backToCustomer" class="btn btn-warning">Kembali</button>
            <button id="completePayment" class="btn btn-success float-right"><i class="fas fa-print"></i> Selesaikan & Cetak</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Admin Modal -->
<div id="adminModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Admin Dashboard</h3>
      <button class="modal-close">&times;</button>
    </div>
    <div class="tabs">
      <div class="tab active admin-tab" data-tab="products">Produk</div>
      <div class="tab admin-tab" data-tab="categories">Kategori</div>
      <div class="tab admin-tab" data-tab="customers">Pelanggan</div>
      <div class="tab admin-tab" data-tab="transactions">Transaksi</div>
      <div class="tab admin-tab" data-tab="reports">Laporan</div>
      <div class="tab admin-tab" data-tab="settings">Pengaturan</div>
    </div>

    <div class="tab-content active admin-tab-content" id="productsTab">
      <button id="addProduct" class="btn btn-success mb-3"><i class="fas fa-plus"></i> Tambah</button>
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Barcode</th><th>Nama</th><th>Merk</th><th>Satuan</th><th>Kategori</th>
              <th>Harga&nbsp;Beli</th><th>Harga&nbsp;Jual</th><th>Laba</th><th>Stok</th><th>Aksi</th>
            </tr>
          </thead>
          <tbody id="adminProductsTable"></tbody>
        </table>
      </div>
    </div>

    <div class="tab-content admin-tab-content" id="categoriesTab">
      <button id="addCategory" class="btn btn-success mb-3"><i class="fas fa-plus"></i> Tambah</button>
      <div class="table-responsive">
        <table class="table">
          <thead><tr><th>ID</th><th>Nama</th><th>Deskripsi</th><th>Jumlah&nbsp;Produk</th><th>Aksi</th></tr></thead>
          <tbody id="adminCategoriesTable"></tbody>
        </table>
      </div>
    </div>

    <div class="tab-content admin-tab-content" id="customersTab">
      <button id="addCustomer" class="btn btn-success mb-3"><i class="fas fa-plus"></i> Tambah</button>
      <div class="table-responsive">
        <table class="table">
          <thead><tr><th>ID</th><th>Nama</th><th>Telepon</th><th>Email</th><th>Tipe</th><th>Aksi</th></tr></thead>
          <tbody id="adminCustomersTable"></tbody>
        </table>
      </div>
    </div>

    <div class="tab-content admin-tab-content" id="transactionsTab">
      <div class="form-group">
        <label>Rentang Tanggal</label>
        <input type="text" id="transactionDateRange" class="form-control" readonly>
      </div>
      <div class="table-responsive">
        <table class="table">
          <thead><tr><th>ID</th><th>Tanggal</th><th>Pelanggan</th><th>Total</th><th>Laba</th><th>Kasir</th><th>Aksi</th></tr></thead>
          <tbody id="adminTransactionsTable"></tbody>
        </table>
      </div>
    </div>

    <div class="tab-content admin-tab-content" id="reportsTab">
      <div class="form-group">
        <label>Rentang Tanggal</label>
        <input type="text" id="reportDateRange" class="form-control" readonly>
      </div>
      <div class="report-summary">
        <div class="report-card"><div class="report-card-title">Total Transaksi</div><div class="report-card-value" id="reportTotalTransactions">0</div></div>
        <div class="report-card"><div class="report-card-title">Total Pendapatan</div><div class="report-card-value" id="reportTotalRevenue">Rp 0</div></div>
        <div class="report-card"><div class="report-card-title">Total Laba</div><div class="report-card-value" id="reportTotalProfit">Rp 0</div></div>
        <div class="report-card"><div class="report-card-title">Produk Terlaris</div><div class="report-card-value" id="reportBestSeller">-</div></div>
      </div>
      <canvas id="salesChart" height="200"></canvas>
      <div class="mt-3">
        <button id="exportReportExcel" class="btn btn-success"><i class="fas fa-file-excel"></i> Excel</button>
      </div>
    </div>

    <div class="tab-content admin-tab-content" id="settingsTab">
      <div class="form-group"><label>Nama Toko</label><input id="storeNameSetting" class="form-control"></div>
      <div class="form-group"><label>Alamat Toko</label><textarea id="storeAddressSetting" class="form-control"></textarea></div>
      <div class="form-group"><label>Telepon Toko</label><input id="storePhoneSetting" class="form-control"></div>
      <div class="form-group"><label>Pajak (%)</label><input type="number" id="storeTaxRate" class="form-control" value="10"></div>
      <div class="form-group">
        <label>Printer Bluetooth / USB</label>
        <select id="printerSelect" class="form-control">
          <option value="">-- Tidak ada --</option>
        </select>
        <button id="testPrintBtn" class="btn btn-outline mt-2">Test Print</button>
      </div>
      <button id="saveSettings" class="btn btn-success"><i class="fas fa-save"></i> Simpan</button>
    </div>
  </div>
</div>

<!-- Modals -->
<!-- Add Product -->
<div id="productModal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><h3>Tambah Produk</h3><button class="modal-close">&times;</button></div>
    <div class="modal-body">
      <div class="form-group"><label>Barcode</label><input id="productBarcode" class="form-control"></div>
      <div class="form-group"><label>Nama</label><input id="productName" class="form-control"></div>
      <div class="form-group"><label>Merk</label><input id="productBrand" class="form-control"></div>
      <div class="form-group"><label>Satuan</label><input id="productUnit" class="form-control"></div>
      <div class="form-group"><label>Kategori</label><select id="productCategoryModal" class="form-control"></select></div>
      <div class="form-group"><label>Harga Beli</label><input type="number" id="productPurchasePrice" class="form-control"></div>
      <div class="form-group"><label>Harga Jual</label><input type="number" id="productPrice" class="form-control"></div>
      <div class="form-group"><label>Stok</label><input type="number" id="productStock" class="form-control"></div>
      <div class="form-group"><label>Deskripsi (opsional)</label><textarea id="productDescription" class="form-control"></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary close-product-modal">Batal</button>
      <button class="btn btn-success save-product">Simpan</button>
    </div>
  </div>
</div>

<!-- Add Category -->
<div id="categoryModal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><h3>Tambah Kategori</h3><button class="modal-close">&times;</button></div>
    <div class="modal-body">
      <div class="form-group"><label>Nama Kategori</label><input id="categoryName" class="form-control"></div>
      <div class="form-group"><label>Deskripsi</label><textarea id="categoryDescription" class="form-control"></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary close-category-modal">Batal</button>
      <button class="btn btn-success save-category">Simpan</button>
    </div>
  </div>
</div>

<!-- Add Customer -->
<div id="customerModal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><h3>Tambah Pelanggan</h3><button class="modal-close">&times;</button></div>
    <div class="modal-body">
      <div class="form-group"><label>Nama Lengkap</label><input id="customerNameModal" class="form-control"></div>
      <div class="form-group"><label>No. Telepon</label><input id="customerPhoneModal" class="form-control"></div>
      <div class="form-group"><label>Email</label><input id="customerEmailModal" class="form-control"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary close-customer-modal">Batal</button>
      <button class="btn btn-success save-customer">Simpan</button>
    </div>
  </div>
</div>

<!-- Receipt Template -->
<div id="receiptTemplate" style="display:none">
  <div class="receipt">
    <div class="receipt-header">
      <div class="receipt-title" id="receiptStoreName">Toko</div>
      <div class="receipt-address" id="receiptStoreAddress">Jl. Contoh</div>
      <div class="receipt-date" id="receiptDate">-</div>
    </div>
    <div class="receipt-items" id="receiptItems"></div>
    <div class="receipt-total">
      <div class="receipt-item"><span>TOTAL</span><span id="receiptTotal">Rp 0</span></div>
      <div class="receipt-item"><span>Bayar</span><span id="receiptPaymentAmount">Rp 0</span></div>
      <div class="receipt-item"><span>Kembali</span><span id="receiptChange">Rp 0</span></div>
    </div>
    <div class="receipt-footer">Terima kasih telah berbelanja</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
/* ===== CONFIG & HELPERS ===== */
const ADMIN_PASSWORD = '123456';
const STORAGE_KEYS = {
  PRODUCTS: 'pos_products',
  CATEGORIES: 'pos_categories',
  CUSTOMERS: 'pos_customers',
  TRANSACTIONS: 'pos_transactions',
  SETTINGS: 'pos_settings',
  CURRENT_CART: 'pos_current_cart',
  CURRENT_CASHIER: 'pos_current_cashier'
};

let products = [], categories = [], customers = [], transactions = [], settings = {};
let currentCart = { items: [], customer: null, discount: 0, tax: 0, subtotal: 0, total: 0 };
let currentCashier = null;
let salesChart = null;

/* ===== UTIL ===== */
const $ = q => document.querySelector(q);
const $$ = q => [...document.querySelectorAll(q)];
const fmt = n => 'Rp ' + n.toLocaleString('id-ID');
const genId = prefix => prefix + Date.now().toString().slice(-9);
const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));
const load = (k, def = []) => JSON.parse(localStorage.getItem(k)) || def;
const toast = (msg, type = 'info', t = 3000) => {
  const el = $('#toast');
  $('#toastMsg').innerText = msg;
  el.className = 'toast ' + type;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), t);
};

/* ===== INIT DATA ===== */
function initData() {
  products = load(STORAGE_KEYS.PRODUCTS, [
    { id: 'P001', barcode: '123456789', name: 'Sabun Lux', brand: 'Unilever', unit: 'pcs', categoryId: 'C1', purchasePrice: 3000, price: 5000, stock: 20, description: '' },
    { id: 'P002', barcode: '987654321', name: 'Shampoo Clear', brand: 'Unilever', unit: 'pcs', categoryId: 'C1', purchasePrice: 7000, price: 12000, stock: 15, description: '' }
  ]);
  categories = load(STORAGE_KEYS.CATEGORIES, [
    { id: 'C1', name: 'Sabun & Shampoo', description: 'Perawatan rambut & tubuh' }
  ]);
  customers = load(STORAGE_KEYS.CUSTOMERS, [
    { id: 'M1', type: 'walkin', name: 'Umum', phone: '-', email: '' }
  ]);
  transactions = load(STORAGE_KEYS.TRANSACTIONS, []);
  settings = load(STORAGE_KEYS.SETTINGS, {
    storeName: 'Premium POS System',
    storeAddress: 'Jl. Contoh No. 123, Kota Contoh',
    storePhone: '081234567890',
    taxRate: 10,
    defaultDiscount: 0
  });
  currentCart = load(STORAGE_KEYS.CURRENT_CART, { items: [], customer: null, discount: 0, tax: 0, subtotal: 0, total: 0 });
  currentCashier = load(STORAGE_KEYS.CURRENT_CASHIER);
}

/* ===== LOGIN ===== */
$('#loginForm').addEventListener('submit', e => {
  e.preventDefault();
  const id = $('#cashierId').value.trim();
  const pin = $('#cashierPin').value.trim();
  if (pin.length !== 4 || !/^\d+$/.test(pin)) { toast('PIN harus 4 digit angka', 'error'); return; }
  if (id === 'admin' && pin === ADMIN_PASSWORD) {
    currentCashier = { id: 'admin', name: 'Admin' };
    openApp();
  } else {
    toast('ID atau PIN salah', 'error');
  }
});

function openApp() {
  save(STORAGE_KEYS.CURRENT_CASHIER, currentCashier);
  $('#loginModal').style.display = 'none';
  $('#mainApp').style.display = 'block';
  renderUI();
}

$('#logoutBtn').addEventListener('click', () => {
  currentCashier = null;
  localStorage.removeItem(STORAGE_KEYS.CURRENT_CASHIER);
  location.reload();
});

/* ===== RENDER UI ===== */
function renderUI() {
  $('#storeName').innerText = settings.storeName;
  $('#storeAddress').innerText = settings.storeAddress;
  $('#currentDate').innerText = new Date().toLocaleString('id-ID');
  $('#loggedInCashier').innerText = currentCashier?.name || '';
  loadProducts();
  loadCategories();
  loadCustomers();
  updateCart();
}

/* ===== PRODUCTS ===== */
function loadProducts(filter = '') {
  const tbody = $('#productListBody');
  tbody.innerHTML = '';
  const filtered = products.filter(p => !filter || p.name.toLowerCase().includes(filter.toLowerCase()) || p.barcode.includes(filter));
  filtered.forEach(p => {
    const stockClass = p.stock > 5 ? 'text-success' : p.stock > 0 ? 'text-warning' : 'text-danger';
    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${p.name}</td>
        <td>${fmt(p.price)}</td>
        <td class="${stockClass}">${p.stock}</td>
        <td><button class="btn btn-success btn-sm add-to-cart" data-id="${p.id}" ${p.stock <= 0 ? 'disabled' : ''}>+</button></td>
      </tr>
    `);
  });
}

/* ===== CART ===== */
function updateCart() {
  const container = $('#cartItems');
  if (currentCart.items.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="fas fa-shopping-cart"></i><p>Keranjang kosong</p></div>';
  } else {
    container.innerHTML = '';
    currentCart.items.forEach((item, idx) => {
      container.insertAdjacentHTML('beforeend', `
        <div class="cart-item">
          <div>${item.product.name} (${item.product.unit})</div>
          <div>
            <button class="btn btn-sm" onclick="changeQty(${idx}, -1)">-</button>
            <span>${item.quantity}</span>
            <button class="btn btn-sm" onclick="changeQty(${idx}, 1)">+</button>
            <button class="btn btn-danger btn-sm" onclick="removeItem(${idx})"><i class="fas fa-trash"></i></button>
          </div>
        </div>
      `);
    });
  }
  currentCart.subtotal = currentCart.items.reduce((a, b) => a + b.product.price * b.quantity, 0);
  currentCart.tax = (currentCart.subtotal * settings.taxRate) / 100;
  currentCart.total = currentCart.subtotal - currentCart.discount + currentCart.tax;
  $('#cartSubtotal').innerText = fmt(currentCart.subtotal);
  $('#cartDiscount').innerText = fmt(currentCart.discount);
  $('#cartTax').innerText = fmt(currentCart.tax);
  $('#cartTotal').innerText = fmt(currentCart.total);
  $('#paymentSubtotal').innerText = fmt(currentCart.subtotal);
  $('#paymentDiscount').innerText = fmt(currentCart.discount);
  $('#paymentTax').innerText = fmt(currentCart.tax);
  $('#paymentTotal').innerText = fmt(currentCart.total);
  save(STORAGE_KEYS.CURRENT_CART, currentCart);
}

function changeQty(idx, delta) {
  const item = currentCart.items[idx];
  if (item.quantity + delta <= 0 || item.quantity + delta > item.product.stock) return;
  item.quantity += delta;
  updateCart();
}

function removeItem(idx) {
  currentCart.items.splice(idx, 1);
  updateCart();
}

/* ===== TABS ===== */
$$('.tab').forEach(tab => {
  tab.addEventListener('click', e => {
    $$('.tab').forEach(t => t.classList.remove('active'));
    $$('.tab-content').forEach(c => c.classList.remove('active'));
    e.target.classList.add('active');
    $(e.target.dataset.tab + 'Tab').classList.add('active');
  });
});

/* ===== CUSTOMER ===== */
$('#customerType').addEventListener('change', e => {
  const val = e.target.value;
  $('#memberFields').style.display = val === 'member' ? 'block' : 'none';
  $('#customerFields').style.display = val === 'walkin' ? 'block' : 'none';
});

/* ===== PAYMENT ===== */
$('#completePayment').addEventListener('click', () => {
  const paid = Number($('#paymentAmount').value) || 0;
  if (paid < currentCart.total) { toast('Uang kurang', 'error'); return; }

  const profit = currentCart.items.reduce((a, b) => a + (b.product.price - (b.product.purchasePrice || b.product.price)) * b.quantity, 0);
  const transaction = {
    id: genId('T'),
    date: new Date(),
    items: currentCart.items,
    customer: {
      type: $('#customerType').value,
      name: $('#customerType').value === 'member' ? $('#customerName').value : 'Umum',
      phone: $('#customerPhone').value || '-'
    },
    subtotal: currentCart.subtotal,
    discount: currentCart.discount,
    tax: currentCart.tax,
    total: currentCart.total,
    profit,
    paymentMethod: $('input[name="paymentMethod"]:checked').value,
    paymentAmount: paid,
    change: paid - currentCart.total,
    cashier: currentCashier
  };

  transactions.unshift(transaction);
  currentCart.items.forEach(i => {
    const p = products.find(pr => pr.id === i.product.id);
    if (p) p.stock -= i.quantity;
  });
  save(STORAGE_KEYS.TRANSACTIONS, transactions);
  save(STORAGE_KEYS.PRODUCTS, products);
  printReceipt(transaction);
  resetCart();
  toast('Transaksi berhasil', 'success');
});

function resetCart() {
  currentCart = { items: [], customer: null, discount: 0, tax: 0, subtotal: 0, total: 0 };
  save(STORAGE_KEYS.CURRENT_CART, currentCart);
  updateCart();
  $('#customerType').value = 'walkin';
  $('#customerName').value = '';
  $('#customerPhone').value = '';
  $('#paymentAmount').value = '';
  $$('.tab')[0].classList.add('active');
  $$('.tab')[1].classList.remove('active');
  $$('.tab')[2].classList.remove('active');
  $('#cartTab').classList.add('active');
  $('#customerTab').classList.remove('active');
  $('#paymentTab').classList.remove('active');
}

/* ===== PRINT ===== */
function printReceipt(t) {
  const el = $('#receiptTemplate').cloneNode(true);
  el.style.display = 'block';
  el.querySelector('#receiptStoreName').innerText = settings.storeName;
  el.querySelector('#receiptStoreAddress').innerText = settings.storeAddress;
  el.querySelector('#receiptDate').innerText = new Date(t.date).toLocaleString('id-ID');
  const itemsEl = el.querySelector('#receiptItems');
  itemsEl.innerHTML = '';
  t.items.forEach(i => {
    itemsEl.insertAdjacentHTML('beforeend', `
      <div class="receipt-item"><span>${i.product.name} x${i.quantity}</span><span>${fmt(i.product.price * i.quantity)}</span></div>
    `);
  });
  el.querySelector('#receiptTotal').innerText = fmt(t.total);
  el.querySelector('#receiptPaymentAmount').innerText = fmt(t.paymentAmount);
  el.querySelector('#receiptChange').innerText = fmt(t.change);
  document.body.appendChild(el);
  window.print();
  setTimeout(() => el.remove(), 1000);
}

/* ===== ADMIN MODALS ===== */
$('#adminAccess').addEventListener('click', () => $('#adminModal').style.display = 'flex');
$$('.modal-close').forEach(btn => btn.addEventListener('click', e => e.target.closest('.modal').style.display = 'none'));

/* Add Product Modal */
$('#addProduct').addEventListener('click', () => {
  loadCategories();
  $('#productModal').style.display = 'flex';
});
$('.save-product').addEventListener('click', () => {
  const p = {
    id: genId('P'),
    barcode: $('#productBarcode').value,
    name: $('#productName').value,
    brand: $('#productBrand').value,
    unit: $('#productUnit').value,
    categoryId: $('#productCategoryModal').value,
    purchasePrice: Number($('#productPurchasePrice').value) || 0,
    price: Number($('#productPrice').value) || 0,
    stock: Number($('#productStock').value) || 0,
    description: $('#productDescription').value
  };
  if (!p.name || !p.price) { toast('Nama & harga wajib', 'error'); return; }
  products.push(p);
  save(STORAGE_KEYS.PRODUCTS, products);
  loadProducts();
  $('#productModal').style.display = 'none';
  toast('Produk disimpan', 'success');
});

/* Add Category Modal */
$('#addCategory').addEventListener('click', () => $('#categoryModal').style.display = 'flex');
$('.save-category').addEventListener('click', () => {
  const c = { id: genId('C'), name: $('#categoryName').value, description: $('#categoryDescription').value };
  if (!c.name) { toast('Nama kategori wajib', 'error'); return; }
  categories.push(c);
  save(STORAGE_KEYS.CATEGORIES, categories);
  loadCategories();
  $('#categoryModal').style.display = 'none';
});

/* Add Customer Modal */
$('#addCustomer').addEventListener('click', () => $('#customerModal').style.display = 'flex');
$('.save-customer').addEventListener('click', () => {
  const c = { id: genId('M'), type: 'member', name: $('#customerNameModal').value, phone: $('#customerPhoneModal').value, email: $('#customerEmailModal').value };
  if (!c.name || !c.phone) { toast('Nama & telepon wajib', 'error'); return; }
  customers.push(c);
  save(STORAGE_KEYS.CUSTOMERS, customers);
  loadCustomers();
  $('#customerModal').style.display = 'none';
});

/* ===== ADMIN TABLES ===== */
function loadCategories() {
  const sel = $('#productCategory');
  sel.innerHTML = '<option value="all">Semua Kategori</option>';
  categories.forEach(c => sel.insertAdjacentHTML('beforeend', `<option value="${c.id}">${c.name}</option>`));
  $('#productCategoryModal').innerHTML = sel.innerHTML;

  const tbody = $('#adminCategoriesTable');
  tbody.innerHTML = '';
  categories.forEach(c => {
    const cnt = products.filter(p => p.categoryId === c.id).length;
    tbody.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${c.id}</td>
        <td>${c.name}</td>
        <td>${c.description || '-'}</td>
        <td>${cnt}</td>
        <td>
          <button class="btn btn-danger btn-sm" onclick="deleteCategory('${c.id}')">Hapus</button>
        </td>
      </tr>
    `);
  });
}

function loadCustomers() {
  const tbody = $('#adminCustomersTable');
  tbody.innerHTML = '';
  customers.forEach(c => tbody.insertAdjacentHTML('beforeend', `
    <tr>
      <td>${c.id}</td>
      <td>${c.name}</td>
      <td>${c.phone}</td>
      <td>${c.email || '-'}</td>
      <td>
        <span class="badge ${c.type === 'member' ? 'badge-success' : ''}">${c.type}</span>
      </td>
      <td>
        <button class="btn btn-danger btn-sm" onclick="deleteCustomer('${c.id}')">Hapus</button>
      </td>
    </tr>
  `));
}

function loadAdminTransactions() {
  const tbody = $('#adminTransactionsTable');
  tbody.innerHTML = '';
  transactions.slice(0, 100).forEach(t => tbody.insertAdjacentHTML('beforeend', `
    <tr>
      <td>${t.id}</td>
      <td>${new Date(t.date).toLocaleString('id-ID')}</td>
      <td>${t.customer.name}</td>
      <td>${fmt(t.total)}</td>
      <td>${fmt(t.profit)}</td>
      <td>${t.cashier.name}</td>
      <td>
        <button class="btn btn-info btn-sm" onclick="printReceipt(${JSON.stringify(t).replace(/"/g, '&quot;')})">Cetak</button>
      </td>
    </tr>
  `));
}

/* ===== CHART ===== */
function loadSalesReport() {
  const labels = [];
  const revenueData = [];
  const profitData = [];
  const daily = {};
  transactions.forEach(t => {
    const date = new Date(t.date).toLocaleDateString('id-ID');
    if (!daily[date]) daily[date] = { revenue: 0, profit: 0 };
    daily[date].revenue += t.total;
    daily[date].profit += t.profit;
  });
  Object.keys(daily).sort().forEach(date => {
    labels.push(date);
    revenueData.push(daily[date].revenue);
    profitData.push(daily[date].profit);
  });
  const ctx = $('#salesChart').getContext('2d');
  if (salesChart) salesChart.destroy();
  salesChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Pendapatan', data: revenueData, backgroundColor: '#4361ee' },
        { label: 'Laba', data: profitData, backgroundColor: '#10b981' }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true, ticks: { callback: v => fmt(v) } } }
    }
  });
}

/* ===== SETTINGS ===== */
$('#saveSettings').addEventListener('click', () => {
  settings.storeName = $('#storeNameSetting').value;
  settings.storeAddress = $('#storeAddressSetting').value;
  settings.storePhone = $('#storePhoneSetting').value;
  settings.taxRate = Number($('#storeTaxRate').value) || 0;
  save(STORAGE_KEYS.SETTINGS, settings);
  renderUI();
  toast('Pengaturan disimpan', 'success');
});

/* ===== THEME TOGGLE ===== */
$('#themeToggle').addEventListener('click', () => {
  document.body.classList.toggle('dark');
  $('#themeToggle').innerHTML = document.body.classList.contains('dark')
    ? '<i class="fas fa-sun"></i>'
    : '<i class="fas fa-moon"></i>';
});

/* ===== PWA SERVICE WORKER ===== */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register(
    URL.createObjectURL(new Blob([`
      self.addEventListener('install', e => e.waitUntil(caches.open('pos-v1').then(c => c.addAll(['index.html']))));
      self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))));
    `], { type: 'application/javascript' }))
  );
}

/* ===== INIT ===== */
initData();
loadCategories();
loadCustomers();
loadAdminTransactions();
loadSalesReport();
</script>
</body>
</html>
